<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta
    name="viewport"
    content="width=device-width,initial-scale=1,maximum-scale=1,viewport-fit=cover,user-scalable=no"
  />
  <title>Earth Defender</title>

  <!-- Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@600;700&family=JetBrains+Mono:wght@500;600&display=swap" rel="stylesheet"/>

  <style>
    :root{
      --font-primary:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      --font-display:'Space Grotesk','Inter',sans-serif;
      --font-mono:'JetBrains Mono','Courier New',monospace;

      --bg:#0a0e1a; --bg2:#121825; --bg3:#1a2332;
      --accent:#22d3ee; --accent2:#06b6d4;
      --ok:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --text:#f8fafc; --text2:#cbd5e1; --text3:#64748b;
      --brd:rgba(255,255,255,.12);

      --xs:.65rem; --sm:.8rem; --base:.95rem; --lg:1.1rem; --xl:1.3rem; --xxl:1.6rem; --xxxl:2rem;

      --s1:.25rem; --s2:.5rem; --s3:.75rem; --s4:1rem; --s5:1.5rem; --s6:2rem; --s8:3rem;
      --r-sm:6px; --r-md:10px; --r-lg:14px; --r-full:9999px;
      --shadow:0 6px 22px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box; margin:0; padding:0}
    html,body{height:100%; overflow:hidden}
    body{background:var(--bg); color:var(--text); font-family:var(--font-primary); -webkit-tap-highlight-color:transparent}

    /* Canvas */
    #gameCanvas{
      position:fixed; inset:0; width:100vw; height:100vh; display:block;
      background:#000; image-rendering:pixelated; touch-action:none;
    }

    /* Title image */
    #titleImage{
      position:absolute; left:50%; top:25%; transform:translate(-50%,-50%);
      width:90%; max-width:420px; z-index:201; mix-blend-mode:lighten; opacity:.95; display:block;
    }

    /* HUD */
    #hud{
      position:fixed; top:10px; left:10px; right:10px; z-index:120;
      display:none; gap:12px; pointer-events:none;
    }
    .hud-group{
      pointer-events:none;
      background:rgba(18,24,37,.85); border:1px solid var(--brd); border-radius:var(--r-md);
      padding:10px 14px; display:flex; gap:16px; flex:1; justify-content:space-between; box-shadow:var(--shadow);
    }
    .hud-stat{display:flex; flex-direction:column; align-items:center; min-width:0}
    .hud-label{font-size:var(--xs); color:var(--text3)}
    .hud-value{font-family:var(--font-mono); font-size:var(--lg)}

    /* Missile */
    #missileButton{
      position:fixed; right:20px; bottom:28px; z-index:120; display:none;
      width:72px; height:72px; border-radius:var(--r-full); border:2px solid rgba(239,68,68,.45);
      background:var(--bad); color:#fff; font-weight:700; box-shadow:var(--shadow); cursor:pointer;
    }

    /* Menu â€“ lower quadrant */
    #menu{
      position:absolute; left:50%; transform:translateX(-50%); bottom:6%;
      display:flex; flex-direction:column; gap:10px; z-index:200; width:min(92vw,520px); text-align:center;
    }
    #menu .button{width:220px; margin:0 auto}
    .difficulty-buttons{display:flex; gap:8px; justify-content:center; margin-top:4px}
    .difficulty-buttons .button{width:90px; padding:10px 0}

    /* Buttons */
    .button{
      background:var(--accent); color:#03202a; border:none; border-radius:var(--r-md);
      padding:12px 18px; font-weight:700; cursor:pointer; box-shadow:var(--shadow); transition:.18s transform, .18s filter;
    }
    .button:hover{filter:brightness(1.05)}
    .button:active{transform:scale(.98)}
    .button-secondary{background:var(--bg2); color:var(--text); border:1px solid var(--brd)}
    .button-secondary:hover{border-color:var(--accent)}

    /* Interstitials */
    .interstitial-screen{
      position:absolute; left:50%; top:50%; transform:translate(-50%,-50%);
      width:min(92vw,600px); max-height:85vh; overflow:auto;
      background:var(--bg2); border:1px solid var(--brd); border-radius:var(--r-lg);
      padding:var(--s6); display:none; flex-direction:column; gap:var(--s5); z-index:400;
      box-shadow:var(--shadow); text-align:left;
    }
    .interstitial-screen h2{font-family:var(--font-display); font-size:var(--xxl); color:var(--accent); text-align:center}
    .interstitial-screen p{font-size:var(--base); color:var(--text2)}
    #shop{padding:var(--s5)}
    .shop-header{display:flex; align-items:center; gap:var(--s4); border-bottom:1px solid var(--brd); padding-bottom:var(--s4)}
    .shop-header h2{flex:1; text-align:left}
    .shop-header-right{display:flex; align-items:center; gap:var(--s4)}
    .shop-balance{font-family:var(--font-mono); font-size:var(--xl); color:var(--warn)}
    .shop-tabs{display:flex; gap:8px}
    .tab{padding:6px 10px; border-radius:8px; border:1px solid var(--brd); background:transparent; color:var(--text2); cursor:pointer}
    .tab.active{color:var(--accent); border-color:var(--accent); background:rgba(34,211,238,.08)}
    .shop-items{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px}
    .item-card{background:var(--bg3); border:1px solid var(--brd); border-radius:10px; padding:10px; text-align:center}
    .item-card.equipped{border-color:var(--ok); box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .item-sprite{width:100px; height:100px; object-fit:contain; background:#000; border-radius:6px; margin:0 auto}
    .item-name{font-weight:700; color:var(--accent)}
    .item-desc{font-size:.75rem; color:var(--text2)}
    .item-price{font-family:var(--font-mono); color:var(--warn)}
    .item-equipped-badge{font-size:.7rem; color:var(--ok)}

    /* Victory / Album art (keep aspect ratio, no squish) */
    .album-art{
      display:block; margin:var(--s4) auto;
      max-width:min(90vw, 900px); width:100%; height:auto; /* <-- critical: no fixed height */
      border-radius:12px; box-shadow:var(--shadow);
    }

    /* Audio controls */
    #audioControls{position:absolute; right:12px; top:12px; z-index:500; display:flex; gap:8px}
    .audio-btn{
      width:42px; height:42px; border-radius:var(--r-full); border:1px solid var(--brd);
      background:var(--bg2); color:var(--text); display:flex; align-items:center; justify-content:center;
      cursor:pointer; font-size:20px;
    }
    .audio-btn.muted{background:rgba(239,68,68,.1); color:var(--bad); border-color:rgba(239,68,68,.4)}

    /* Small screens */
    @media (max-width:768px){
      .hud-group{gap:10px; padding:8px 10px}
      .hud-value{font-size:1rem}
    }
  </style>
</head>
<body>
  <!-- Audio controls -->
  <div id="audioControls" style="display:flex">
    <button id="muteBtn" class="audio-btn" title="Toggle sound" aria-pressed="false">ðŸ”Š</button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>

  <!-- Title -->
  <img id="titleImage" src="assets/gametitle.jpg" alt="Earth Defender"/>

  <!-- HUD -->
  <div id="hud">
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Wave</span><span id="waveDisplay" class="hud-value">1</span></div>
      <div class="hud-stat"><span class="hud-label">Score</span><span id="scoreDisplay" class="hud-value">0</span></div>
    </div>
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Lives</span><span id="livesDisplay" class="hud-value">3</span></div>
      <div class="hud-stat"><span class="hud-label">Coins</span><span id="coinsDisplay" class="hud-value">100</span></div>
      <div class="hud-stat"><span class="hud-label">Missiles</span><span id="missilesDisplay" class="hud-value">3</span></div>
    </div>
  </div>

  <!-- Missile button -->
  <button id="missileButton" onclick="window.Game?.launchMissile?.()">Fire</button>

  <!-- Menu -->
  <div id="menu">
    <button class="button" onclick="window.Game?.startGame?.('normal')">Start</button>
    <button class="button button-secondary" onclick="window.Game?.showShop?.()">Shop</button>
    <button class="button button-secondary" onclick="window.Game?.showTutorial?.()">Help</button>
    <div class="difficulty-buttons">
      <button class="button" onclick="window.Game?.startGame?.('easy')">Easy</button>
      <button class="button" onclick="window.Game?.startGame?.('normal')">Normal</button>
      <button class="button" onclick="window.Game?.startGame?.('hard')">Hard</button>
    </div>
  </div>

  <!-- Shop -->
  <div id="shop" class="interstitial-screen">
    <div class="shop-header">
      <h2>Upgrades</h2>
      <div class="shop-header-right">
        <span id="shopBalance" class="shop-balance">100</span>
        <button class="button button-secondary" onclick="window.Game?.closeShop?.()">Close</button>
      </div>
    </div>
    <div class="shop-tabs">
      <button class="tab active" onclick="window.Game?.switchTab?.('weapons', this)">Weapons</button>
      <button class="tab" onclick="window.Game?.switchTab?.('shields', this)">Shields</button>
      <button class="tab" onclick="window.Game?.switchTab?.('systems', this)">Systems</button>
    </div>
    <div id="shopItems" class="shop-items"></div>
  </div>

  <!-- Wave choice / transition -->
  <div id="waveChoice" class="interstitial-screen">
    <h2>Choose Your Upgrade</h2>
    <p>Pick one to power up for the next wave.</p>
    <div id="choiceCards" class="shop-items" style="grid-template-columns:repeat(auto-fit,minmax(220px,1fr));"></div>
  </div>

  <div id="waveTransition" class="interstitial-screen">
    <h2>Wave Complete!</h2>
    <p style="text-align:center">Prepare for the next assault.</p>
    <div style="display:flex; gap:10px; justify-content:center">
      <button class="button" onclick="window.Game?.resumeGame?.()">Next Wave</button>
      <button class="button button-secondary" onclick="window.Game?.showInGameShop?.()">Visit Shop</button>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorial" class="interstitial-screen">
    <h2>How to Play</h2>
    <p>
      <strong>Objective:</strong> Defend Earth by destroying incoming enemy ships before they reach the planet.<br><br>
      <strong>Controls:</strong> Your ship orbits Earth. Move the mouse (desktop) or swipe vertically (mobile) to rotate. Firing is automatic.<br><br>
      <strong>Missiles:</strong> Tap the missile button to launch a homing missile. You earn more between waves.<br><br>
      <strong>Upgrades:</strong> After each wave, choose a temporary upgrade. Use coins to buy permanent upgrades in the shop.
    </p>
    <div style="text-align:center">
      <button class="button" onclick="window.Game?.closeTutorial?.()">Back to Menu</button>
    </div>
  </div>

  <!-- Pause -->
  <div id="pauseScreen" class="interstitial-screen" style="max-width:420px">
    <h2>Paused</h2>
    <p style="text-align:center">Press ESC to resume</p>
  </div>

  <!-- Death -->
  <div id="deathScreen" class="interstitial-screen" style="border:2px solid var(--bad)">
    <h2 style="color:var(--bad)">Mission Failed</h2>
    <div id="deathStats" class="death-stats"></div>
    <div id="deathRecommendation" class="death-recommendation"></div>
    <div style="text-align:center">
      <button class="button" onclick="window.Game?.closeDeathScreen?.()">Continue</button>
    </div>
  </div>

  <!-- Victory -->
  <div id="victoryScreen" class="interstitial-screen" style="border:2px solid var(--ok)">
    <h2 style="color:var(--ok)">Victory!</h2>
    <!-- Aspect ratio preserved -->
    <img src="assets/IMG_1538.PNG" alt="Album Art" class="album-art"/>
    <div class="credits-text" style="text-align:center">
      <p><strong>Game Design</strong><br/>D_York</p>
      <p><strong>Original Music by D_York</strong><br/>Represented by United Masters</p>
      <p>Available on <a href="https://unitedmasters.com/m/oh-death-1" target="_blank" style="color:var(--accent)">Spotify &amp; Apple Music</a></p>
    </div>
    <div style="text-align:center">
      <button class="button" onclick="window.Game?.closeVictoryScreen?.()">Main Menu</button>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    /************ Small utilities (prevent null crashes) ************/
    const $ = (id) => document.getElementById(id);
    const safeText = (id, v) => { const el = $(id); if (el) el.textContent = v; };
    const safeShow = (id, disp='block') => { const el = $(id); if (el) el.style.display = disp; };
    const safeHide = (id) => { const el = $(id); if (el) el.style.display = 'none'; };

    /*********************** Audio Manager **************************/
    class AudioManager {
      constructor() {
        this.ctx = null;            // WebAudio (for SFX)
        this.music = {};            // HTMLAudioElement per track
        this.current = null;        // current HTMLAudioElement
        this.playlist = [];
        this.i = 0;
        this.musicVol = 0.45;
        this.sfxVol = 0.6;
        this.muted = false;

        this.tracks = {
          menu:     ['assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'],
          gameplay: [
            'assets/audio/m33_-_4_26_25__11_13_AM.m4a',
            'assets/audio/MIAMI__mret_-_5_27_24__5_09_PM_.m4a',
            'assets/audio/goodroots - 1_17_25, 9.41 PM.m4a',
            'assets/audio/newleed - 9_28_24, 6.48 PM.m4a',
            'assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'
          ],
          boss:     ['assets/audio/monster.mp3','assets/audio/dumplin_-_7_6_24__8_51_PM.m4a'],
          victory:  ['assets/audio/propane2 - 12_21_24, 10.27 AM.m4a'],
          gameover: ['assets/audio/gameover.mp3']
        };

        this._init();
      }

      async _init() {
        try {
          this.ctx = (window.AudioContext ? new AudioContext() : (window.webkitAudioContext ? new webkitAudioContext() : null));
        } catch { this.ctx = null; }
        // Precreate HTMLAudio elements
        const every = Object.values(this.tracks).flat();
        await Promise.all(every.map(src => new Promise(res => {
          const a = new Audio(src);
          a.preload = 'auto'; a.loop = false; a.volume = 0;
          a.oncanplaythrough = () => res();
          a.onerror = () => res();
          // safari sometimes needs a load() kick
          setTimeout(() => res(), 2000);
          a.load();
          this.music[src] = a;
        })));
      }

      ensureUnlocked() {
        if (this.ctx && this.ctx.state === 'suspended') {
          try { this.ctx.resume(); } catch {}
        }
      }

      toggleMute() {
        this.muted = !this.muted;
        if (this.current) this.current.volume = this.muted ? 0 : this.musicVol;
        const btn = $('muteBtn');
        if (btn) {
          btn.classList.toggle('muted', this.muted);
          btn.setAttribute('aria-pressed', String(this.muted));
          btn.textContent = this.muted ? 'ðŸ”‡' : 'ðŸ”Š';
        }
      }

      stop(fade=600) {
        if (!this.current) return;
        const a = this.current;
        const start = a.volume;
        const steps = 16, dt = fade/steps;
        let n = 0;
        const t = setInterval(() => {
          n++; a.volume = Math.max(0, start*(1 - n/steps));
          if (n>=steps) { clearInterval(t); a.pause(); a.currentTime = 0; a.volume = 0; }
        }, dt);
      }

      _playTrack(src, fade=1200, loop=true, chain=false) {
        if (this.muted) return;
        const a = this.music[src];
        if (!a) return;
        if (this.current && this.current !== a) { try{ this.current.pause(); }catch{} }
        this.current = a;
        a.loop = loop;
        a.currentTime = 0;
        a.volume = 0;
        a.play().then(() => {
          const target = this.musicVol;
          const steps = 20, dt = fade/steps; let n = 0;
          const t = setInterval(() => {
            n++; a.volume = this.muted ? 0 : Math.min(target, (target*n/steps));
            if (n>=steps) clearInterval(t);
          }, dt);
        }).catch(()=>{});
        if (chain) {
          a.onended = () => this.playNext();
        } else {
          a.onended = null;
        }
      }

      shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

      playList(name, fade=1200) {
        if (!this.tracks[name] || this.tracks[name].length===0) return;
        this.playlist = [...this.tracks[name]];
        if (name==='menu' || name==='gameplay') this.shuffle(this.playlist);
        this.i = 0;
        const loop = this.playlist.length===1;
        this._playTrack(this.playlist[this.i], fade, loop, !loop);
      }
      playNext() {
        if (this.playlist.length<=1) return;
        this.i = (this.i+1) % this.playlist.length;
        this._playTrack(this.playlist[this.i], 800, false, true);
      }

      /* SFX via WebAudio (simple bleeps) */
      sfxShoot(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='square'; o.frequency.setValueAtTime(220,t); o.frequency.exponentialRampToValueAtTime(80,t+.08); g.gain.setValueAtTime(.35*this.sfxVol,t); g.gain.exponentialRampToValueAtTime(.01,t+.1); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+.1); }
      sfxHit(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='sawtooth'; o.frequency.setValueAtTime(180,t); o.frequency.exponentialRampToValueAtTime(60,t+.06); g.gain.setValueAtTime(.4*this.sfxVol,t); g.gain.exponentialRampToValueAtTime(.01,t+.06); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+.07); }
      sfxExplosion(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime, b=this.ctx.createBuffer(1, this.ctx.sampleRate*.4, this.ctx.sampleRate); const d=b.getChannelData(0); for(let i=0;i<d.length;i++){ d[i]= (Math.random()*2-1) * (1 - i/d.length); } const s=this.ctx.createBufferSource(); s.buffer=b; const g=this.ctx.createGain(); g.gain.setValueAtTime(.5*this.sfxVol,t); g.gain.exponentialRampToValueAtTime(.01,t+.4); s.connect(g); g.connect(this.ctx.destination); s.start(t); }
      sfxMissile(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime, o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='triangle'; o.frequency.setValueAtTime(500,t); o.frequency.exponentialRampToValueAtTime(150,t+.25); g.gain.setValueAtTime(.35*this.sfxVol,t); g.gain.exponentialRampToValueAtTime(.01,t+.25); o.connect(g); g.connect(this.ctx.destination); o.start(t); o.stop(t+.26); setTimeout(()=>this.sfxExplosion(),260); }
      sfxUpgrade(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime; [440,554,659,880].forEach((f,i)=>{ const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.frequency.value=f; g.gain.value=.28*this.sfxVol; o.connect(g); g.connect(this.ctx.destination); const tt=t+i*.1; o.start(tt); g.gain.exponentialRampToValueAtTime(.01,tt+.28); o.stop(tt+.3); }); }
      sfxWarning(){ if(!this.ctx || this.muted) return; const t=this.ctx.currentTime; for(let i=0;i<3;i++){ const o=this.ctx.createOscillator(), g=this.ctx.createGain(); o.type='square'; o.frequency.value = (i%2? 560:440); g.gain.value=.25*this.sfxVol; o.connect(g); g.connect(this.ctx.destination); const tt=t+i*.2; o.start(tt); g.gain.setValueAtTime(0,tt+.15); o.stop(tt+.16); } }

    } // AudioManager

    /*********************** Game **************************/
    function initializeGame(){
      const canvas = $('gameCanvas');
      const ctx = canvas.getContext('2d');

      const CONFIG = {
        ORBIT_RADIUS: 60,
        SHIP_SIZE: 58,
        EARTH_COLLISION_RADIUS: 45,
        ENEMY_HIT_RADIUS: 24,
        BOSS_HIT_RADIUS: 80,
        MAX_WAVES: 20,
        INITIAL_LIVES: 3,
        INITIAL_COINS: 100,
        INITIAL_MISSILES: 3
      };

      // Sizes
      function resize(){
        canvas.width = innerWidth; canvas.height = innerHeight;
        // (Background is drawn to cover; Earth sits ~center)
        earthX = canvas.width/2; earthY = canvas.height/2;
      }
      addEventListener('resize', resize, {passive:true});
      resize();

      // Assets (match your repo names exactly)
      const bgImg = new Image(); bgImg.src = 'assets/background.png';
      const shipOk = new Image(); shipOk.src = 'assets/player-ship.jpg';
      const shipBad = new Image(); shipBad.src = 'assets/player-ship-damaged.jpg';
      const enemySheet = new Image(); enemySheet.src = 'assets/enemies.jpg';
      const bossProj = new Image(); bossProj.src = 'assets/IMG_1439_2.JPG';

      // Audio
      const audio = new AudioManager();

      // State
      let gameRunning=false, paused=false, wave=1, score=0, lives=CONFIG.INITIAL_LIVES, coins=CONFIG.INITIAL_COINS, missiles=CONFIG.INITIAL_MISSILES;
      let shipAngle=0, targetAngle=0, shipX=0, shipY=0;
      let enemies=[], projectiles=[], missilesArr=[], bossProjectiles=[];
      let last=performance.now(), earthX=canvas.width/2, earthY=canvas.height/2;

      // Shop data (minimal but present)
      const shopItems = {
        weapons:[
          {id:'basic', name:'Basic Cannon', cost:0, damage:1, fireRate:400, desc:'Standard issue.', sprite:'assets/IMG_1426_2.jpg'},
          {id:'spread', name:'Spread Shot', cost:250, damage:.8, fireRate:450, desc:'5-way fan.', pattern:'spread', sprite:'assets/IMG_1405_2.jpg'},
          {id:'piercing', name:'Rail Gun', cost:500, damage:5, fireRate:1000, desc:'Pierces all.', beam:true, piercing:true, sprite:'assets/1408_2.jpg'}
        ],
        shields:[
          {id:'basic', name:'Energy Shield', cost:300, health:100, desc:'Absorbs 100.', sprite:'assets/IMG_1424_2.jpg'},
        ],
        systems:[
          {id:'speed', name:'Thrusters', cost:300, speedBoost:1.5, desc:'Rotate faster.', sprite:'assets/IMG_1422_2.jpg'}
        ]
      };
      const gameState = {
        equipment: { weapon:'basic', shield:null, system:null },
        owned: { weapons:['basic'], shields:[], systems:[] },
        maxShieldHealth:0, shieldHealth:0, temporaryUpgrades:[]
      };

      // Input
      function setupControls(){
        canvas.addEventListener('mousemove',(e)=>{
          if(!gameRunning||paused) return;
          const r = canvas.getBoundingClientRect();
          targetAngle = Math.atan2(e.clientY - r.top - earthY, e.clientX - r.left - earthX);
        });
        let drag=false, ty=0;
        canvas.addEventListener('touchstart',e=>{ if(!gameRunning||paused) return; drag=true; ty=e.touches[0].clientY; },{passive:true});
        canvas.addEventListener('touchmove',e=>{
          if(!gameRunning||paused||!drag) return;
          const d = e.touches[0].clientY - ty; ty = e.touches[0].clientY; targetAngle += d*0.008;
        },{passive:true});
        canvas.addEventListener('touchend',()=> drag=false);
        document.addEventListener('keydown',(e)=>{
          if(e.key==='Escape'){ paused=!paused; $('pauseScreen').style.display = paused?'flex':'none'; if(!paused){ audio.playList(isBossWave()?'boss':'gameplay'); } else { audio.stop(300); } }
          if(!gameRunning||paused) return;
          if(e.key===' '){ e.preventDefault(); API.launchMissile(); }
          if(e.key==='ArrowLeft'||e.key==='a') targetAngle -= .12;
          if(e.key==='ArrowRight'||e.key==='d') targetAngle += .12;
        });
      }

      function isBossWave(){ return wave>0 && wave%5===0; }

      /*** UI helpers ***/
      function updateUI(){
        safeText('waveDisplay', wave);
        safeText('scoreDisplay', score);
        safeText('livesDisplay', lives);
        safeText('coinsDisplay', coins);
        safeText('missilesDisplay', missiles);
        safeText('shopBalance', coins);
      }

      function showShop(){
        safeHide('menu'); safeHide('deathScreen'); safeShow('shop','flex'); renderShop('weapons');
      }
      function closeShop(){
        safeHide('shop'); safeShow('menu','block');
      }
      function switchTab(tabName, btn){
        document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
        if(btn) btn.classList.add('active');
        renderShop(tabName);
      }
      function renderShop(category){
        const el = $('shopItems'); if(!el) return; el.innerHTML='';
        const items = (shopItems[category]||[]);
        const key = category==='weapons'?'weapon': category==='shields'?'shield':'system';
        items.forEach(item=>{
          const owned = gameState.owned[category]?.includes(item.id);
          const equipped = gameState.equipment[key]===item.id;
          const canAfford = coins>=item.cost;
          const card = document.createElement('div');
          card.className = 'item-card'+(equipped?' equipped':'');
          card.innerHTML = `
            <img src="${item.sprite}" class="item-sprite" alt="${item.name}" onerror="this.style.display='none'"/>
            <div class="item-name">${item.name}</div>
            <div class="item-desc">${item.desc}</div>
            <div class="item-price">${item.cost>0?('ðŸ’° '+item.cost):'Free'}</div>
            ${equipped?'<div class="item-equipped-badge">Equipped</div>':''}
          `;
          if(!owned && item.cost>0){
            const b=document.createElement('button'); b.className='button'; b.textContent=canAfford?'Buy':'Not enough coins'; b.disabled=!canAfford;
            b.onclick=()=>buyItem(category,item.id); card.appendChild(b);
          } else if(!equipped){
            const b=document.createElement('button'); b.className='button'; b.textContent='Equip';
            b.onclick=()=>equipItem(category,item.id); card.appendChild(b);
          }
          el.appendChild(card);
        });
      }
      function buyItem(cat,id){
        const item=(shopItems[cat]||[]).find(i=>i.id===id); if(!item||coins<item.cost) return;
        coins-=item.cost; gameState.owned[cat].push(id); audio.sfxUpgrade(); updateUI(); renderShop(cat);
      }
      function equipItem(cat,id){
        const key = cat==='weapons'?'weapon': cat==='shields'?'shield':'system';
        gameState.equipment[key]=id;
        if(cat==='shields'){
          const s=(shopItems.shields||[]).find(x=>x.id===id);
          gameState.maxShieldHealth = s?.health||0; gameState.shieldHealth = s?.health||0;
        }
        renderShop(cat);
      }

      /*** Game flow ***/
      function startGame(level='normal'){
        // UI
        safeHide('menu'); safeHide('titleImage'); safeShow('hud','flex'); safeShow('missileButton','flex');
        // State
        wave=1; score=0; lives=CONFIG.INITIAL_LIVES; coins = coins||CONFIG.INITIAL_COINS; missiles=CONFIG.INITIAL_MISSILES;
        enemies.length=0; projectiles.length=0; missilesArr.length=0; bossProjectiles.length=0;
        gameRunning=true; paused=false;
        updateUI();
        // Music
        audio.ensureUnlocked();
        audio.playList('gameplay', 900);
      }

      function endGame(){
        audio.stop(400); audio.playList('gameover', 600);
        gameRunning=false; safeHide('hud'); safeHide('missileButton'); safeShow('deathScreen','flex');
      }
      function showVictory(){
        audio.stop(400); audio.playList('victory', 800);
        gameRunning=false; safeHide('hud'); safeHide('missileButton'); safeShow('victoryScreen','flex');
      }
      function closeDeath(){ audio.playList('menu', 600); safeHide('deathScreen'); safeShow('menu','block'); safeShow('titleImage','block'); }
      function closeVictory(){ audio.playList('menu', 600); safeHide('victoryScreen'); safeShow('menu','block'); safeShow('titleImage','block'); }
      function showTutorial(){ safeHide('menu'); safeShow('tutorial','flex'); }
      function closeTutorial(){ safeHide('tutorial'); safeShow('menu','block'); }
      function showInGameShop(){ safeHide('waveTransition'); showShop(); }
      function resumeGame(){ safeHide('waveTransition'); gameRunning=true; }

      /*** Spawning (simple baseline to preserve behavior) ***/
      function spawnWave(){
        // Basic: a few enemies, boss on multiples of 5
        const count = isBossWave()? 1 : Math.min(6 + (wave-1)*2, 28);
        for(let i=0;i<count;i++){
          const ang = Math.random()*Math.PI*2;
          const dist = Math.max(canvas.width, canvas.height)*0.7;
          const sx = earthX + Math.cos(ang)*dist, sy = earthY + Math.sin(ang)*dist;
          const a2 = Math.atan2(earthY - sy, earthX - sx);
          const speed = isBossWave()? 1.0 : (1.0 + Math.random()*0.5);
          enemies.push({
            name: isBossWave()&&i===0?'boss':'regular',
            x:sx, y:sy, vx:Math.cos(a2)*speed, vy:Math.sin(a2)*speed,
            radius: isBossWave()&&i===0? 75: 26,
            health: isBossWave()&&i===0? 120+wave*15 : 6+wave*0.6,
            maxHealth: isBossWave()&&i===0? 120+wave*15 : 6+wave*0.6,
            flash:0
          });
        }
        if (isBossWave()) audio.playList('boss', 800);
      }

      /*** Firing ***/
      let fireTimer=0;
      function fire(dt){
        const w = gameState.equipment.weapon||'basic';
        const def = (shopItems.weapons.find(x=>x.id===w)) || shopItems.weapons[0];
        fireTimer += dt;
        if (fireTimer*1000 >= (def.fireRate||400)) {
          fireTimer=0;
          audio.sfxShoot();
          if (def.pattern==='spread'){
            for(let k=-2;k<=2;k++){
              const a = shipAngle + k*0.15;
              projectiles.push({x:shipX, y:shipY, vx:Math.cos(a)*12, vy:Math.sin(a)*12, damage:def.damage||1, piercing:false});
            }
          } else {
            projectiles.push({x:shipX, y:shipY, vx:Math.cos(shipAngle)*10, vy:Math.sin(shipAngle)*10, damage:def.damage||1, piercing:!!def.piercing});
          }
        }
      }

      function launchMissile(){
        if(missiles<=0 || !gameRunning) return;
        missiles--; updateUI(); audio.sfxMissile();
        missilesArr.push({x:shipX, y:shipY, vx:Math.cos(shipAngle)*6, vy:Math.sin(shipAngle)*6, life:5, damage:12});
      }

      /*** Drawing ***/
      function drawBackground(){
        // simple cover
        ctx.fillStyle = '#0a0e1a'; ctx.fillRect(0,0,canvas.width, canvas.height);
        if (bgImg.complete && bgImg.naturalWidth) {
          const cw=canvas.width, ch=canvas.height, iw=bgImg.width, ih=bgImg.height;
          const ca = cw/ch, ia = iw/ih;
          let dw, dh, dx, dy;
          if (ca>ia){ dw=cw; dh=cw/ia; dx=0; dy=(ch-dh)/2; } else { dh=ch; dw=ch*ia; dy=0; dx=(cw-dw)/2; }
          ctx.drawImage(bgImg, dx,dy,dw,dh);
        }
      }
      function drawShip(){
        shipX = earthX + Math.cos(shipAngle)*CONFIG.ORBIT_RADIUS;
        shipY = earthY + Math.sin(shipAngle)*CONFIG.ORBIT_RADIUS;
        ctx.save();
        ctx.translate(shipX, shipY);
        ctx.rotate(shipAngle + Math.PI/2);
        const img = (lives<=1 && shipBad.complete && shipBad.naturalWidth)? shipBad : (shipOk.complete && shipOk.naturalWidth ? shipOk : null);
        if (img) {
          ctx.globalCompositeOperation='lighter';
          ctx.drawImage(img, -CONFIG.SHIP_SIZE/2, -CONFIG.SHIP_SIZE/2, CONFIG.SHIP_SIZE, CONFIG.SHIP_SIZE);
          ctx.globalCompositeOperation='source-over';
        } else {
          // fallback dot
          ctx.fillStyle='#22d3ee'; ctx.beginPath(); ctx.arc(0,0, CONFIG.SHIP_SIZE/3, 0, Math.PI*2); ctx.fill();
        }
        ctx.restore();
      }
      function drawEnemies(dt){
        for (let i=enemies.length-1;i>=0;i--){
          const e=enemies[i];
          e.x+=e.vx*60*dt; e.y+=e.vy*60*dt;
          // draw
          ctx.save(); ctx.translate(e.x, e.y);
          const rot = Math.atan2(earthY - e.y, earthX - e.x);
          ctx.rotate(rot + Math.PI/2);
          if (e.name==='boss'){
            ctx.fillStyle='#b91c1c'; ctx.beginPath(); ctx.arc(0,0,e.radius,0,Math.PI*2); ctx.fill();
          } else if (enemySheet.complete && enemySheet.naturalWidth){
            ctx.drawImage(enemySheet, -e.radius, -e.radius, e.radius*2, e.radius*2);
          } else {
            ctx.fillStyle='#ef4444'; ctx.beginPath(); ctx.arc(0,0, e.radius, 0,Math.PI*2); ctx.fill();
          }
          ctx.restore();

          // reach earth?
          const d = Math.hypot(e.x-earthX, e.y-earthY);
          if (d < CONFIG.EARTH_COLLISION_RADIUS){
            if (lives>0){ lives--; updateUI(); audio.sfxWarning?.(); }
            enemies.splice(i,1);
            if (lives<=0){ endGame(); return; }
          }
        }
      }
      function drawProjectiles(dt){
        for (let i=projectiles.length-1;i>=0;i--){
          const p=projectiles[i]; p.x+=p.vx*60*dt; p.y+=p.vy*60*dt;
          ctx.fillStyle='#22d3ee'; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill();
          // collide
          for (let j=enemies.length-1;j>=0;j--){
            const e=enemies[j]; const hr = (e.name==='boss')? CONFIG.BOSS_HIT_RADIUS: CONFIG.ENEMY_HIT_RADIUS;
            if (Math.hypot(p.x-e.x, p.y-e.y) < hr){
              e.health -= (p.damage||1);
              audio.sfxHit();
              score += 2;
              if (e.health<=0){
                score += e.name==='boss'? 200: 20;
                coins += e.name==='boss'? 80: 8;
                audio.sfxExplosion();
                enemies.splice(j,1);
              }
              if (!p.piercing){ projectiles.splice(i,1); break; }
            }
          }
          if (p.x< -40 || p.y< -40 || p.x>canvas.width+40 || p.y>canvas.height+40) projectiles.splice(i,1);
        }
      }
      function drawMissiles(dt){
        for (let i=missilesArr.length-1;i>=0;i--){
          const m=missilesArr[i]; m.x+=m.vx*60*dt; m.y+=m.vy*60*dt; m.life-=dt;
          ctx.fillStyle='#f59e0b'; ctx.beginPath(); ctx.arc(m.x,m.y,5,0,Math.PI*2); ctx.fill();
          // simple homing toward nearest
          let target=null, best=1e9;
          enemies.forEach(e=>{ const d=Math.hypot(e.x-m.x,e.y-m.y); if(d<best){best=d; target=e;} });
          if (target){ const a = Math.atan2(target.y-m.y, target.x-m.x); m.vx = Math.cos(a)*8; m.vy = Math.sin(a)*8; }
          for(let j=enemies.length-1;j>=0;j--){
            const e=enemies[j]; const hr = (e.name==='boss')? CONFIG.BOSS_HIT_RADIUS: CONFIG.ENEMY_HIT_RADIUS;
            if (Math.hypot(m.x-e.x, m.y-e.y) < hr){
              e.health -= m.damage; audio.sfxExplosion(); missilesArr.splice(i,1);
              if (e.health<=0){ score += e.name==='boss'?200:20; coins += e.name==='boss'?80:8; enemies.splice(j,1); }
              break;
            }
          }
          if (m.life<=0) missilesArr.splice(i,1);
        }
      }
      function drawBossProjectiles(dt){
        for (let i=bossProjectiles.length-1;i>=0;i--){
          const b=bossProjectiles[i]; b.x+=b.vx*60*dt; b.y+=b.vy*60*dt; b.r+=dt*5;
          ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.r);
          if (bossProj.complete && bossProj.naturalWidth){
            ctx.drawImage(bossProj, -15,-15,30,30);
          } else { ctx.fillStyle='#ff0000'; ctx.fillRect(-10,-10,20,20); }
          ctx.restore();
          if (Math.hypot(b.x-earthX, b.y-earthY) < CONFIG.EARTH_COLLISION_RADIUS){
            if (lives>0){ lives--; updateUI(); }
            bossProjectiles.splice(i,1);
            if (lives<=0){ endGame(); return; }
          }
          if (b.x<-60||b.y<-60||b.x>canvas.width+60||b.y>canvas.height+60) bossProjectiles.splice(i,1);
        }
      }

      /*** Loop ***/
      let spawnTimer = 0, bossShotTimer = 0;
      function loop(t){
        const dt = Math.min(0.033, (t-last)/1000); last=t;
        requestAnimationFrame(loop);

        drawBackground();

        if (!gameRunning){ // idle scene (Earth + ship)
          drawShip(); return;
        }
        if (paused) { drawShip(); return; }

        // aim lerp
        const diff = Math.atan2(Math.sin(targetAngle-shipAngle), Math.cos(targetAngle-shipAngle));
        shipAngle += diff * 0.15;

        // gameplay updates
        spawnTimer += dt;
        if (enemies.length===0 && spawnTimer>0.2){ // next wave
          spawnTimer = 0; wave++; if (wave>CONFIG.MAX_WAVES){ showVictory(); return; } updateUI(); spawnWave();
        }

        // boss fire if any boss exists
        if (enemies.some(e=>e.name==='boss')){
          bossShotTimer += dt;
          if (bossShotTimer>1.6){
            bossShotTimer=0;
            const boss = enemies.find(e=>e.name==='boss');
            if (boss){
              const a = Math.atan2(earthY-boss.y, earthX-boss.x) + (Math.random()-.5)*0.4;
              bossProjectiles.push({x:boss.x, y:boss.y, vx:Math.cos(a)*2.2, vy:Math.sin(a)*2.2, r:0});
            }
          }
        }

        // draw order
        drawShip();
        fire(dt);
        drawProjectiles(dt);
        drawMissiles(dt);
        drawBossProjectiles(dt);
        drawEnemies(dt);

        // lose condition already handled in collisions
      }

      // Public API
      const API = {
        startGame,
        showShop, closeShop, switchTab,
        launchMissile, resumeGame, showInGameShop,
        showTutorial, closeTutorial,
        closeDeathScreen: closeDeath, closeVictoryScreen: closeVictory,
        setDifficulty:(d)=>{},
        // gesture helper to kick audio (exposed to outer listeners)
        kickAudio: () => { audio.ensureUnlocked(); audio.playList('menu', 600); }
      };

      // Init
      function init(){
        setupControls();
        updateUI();
        audio.playList('menu', 800); // menu music on load (will be muted by browser until gesture; we also set gesture kick)
        requestAnimationFrame(loop);
      }
      init();

      return API;
    } // initializeGame

    /**************** Boot + global wiring ****************/
    function wireAudioControls(am){
      const btn = $('muteBtn');
      if (!btn) return;
      btn.addEventListener('click', ()=> {
        am?.toggleMute?.();
      });
    }

    // Create Game once page is loaded and DOM exists
    window.addEventListener('load', () => {
      window.Game = initializeGame();

      // Try autoplay, but also set gesture-unblock fallback
      const gestureKick = () => window.Game?.kickAudio?.();
      window.addEventListener('pointerdown', gestureKick, { once:true });
      window.addEventListener('keydown', gestureKick, { once:true });

      // Hook mute button to our AudioManager via Game.kickAudio() first (unlocks context)
      // The button toggles via AudioManager.toggleMute which we call from inside kickAudio
      // We get a handle to AudioManager by asking Game to kick (ensures it exists/resumed),
      // but for simplicity we just attach the UI and rely on toggle inside AudioManager via global events.
      // Here, we just switch the icon immediately for UX.
      const btn=$('muteBtn'); if(btn){ btn.textContent='ðŸ”Š'; btn.classList.toggle('muted', false); }
    });
  })();
  </script>
</body>
</html>
