<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Earth Defender</title>
  <!-- Inline favicon to avoid 404 -->
  <link rel="icon" href='data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 64 64"><circle cx="32" cy="32" r="30" fill="%2306b6d4"/></svg>'>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@600;700&family=JetBrains+Mono:wght@500;600&display=swap');
    :root{
      --font-primary:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      --font-display:'Space Grotesk','Inter',sans-serif;
      --font-mono:'JetBrains Mono','Courier New',monospace;
      --bg:#0a0e1a; --bg-2:#121825; --bg-3:#1a2332;
      --accent:#22d3ee; --accent-2:#06b6d4;
      --good:#10b981; --warn:#f59e0b; --bad:#ef4444;
      --text:#f8fafc; --text-2:#cbd5e1; --text-3:#64748b; --brd:rgba(255,255,255,.1);
      --r-md:10px; --r-lg:14px; --r-full:9999px;
      --z-hud:100; --z-menu:200; --z-title:201; --z-modal:400; --z-audio:1000;
    }
    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent}
    html,body{height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:var(--font-primary)}
    #gameCanvas{position:fixed; inset:0; width:100vw; height:100vh; image-rendering:pixelated; display:block; background:var(--bg)}
    #titleImage{position:absolute; top:25%; left:50%; transform:translate(-50%,-50%); width:min(90vw,400px); z-index:var(--z-title); mix-blend-mode:lighten; opacity:.95}
    #hud{position:fixed; top:10px; left:10px; right:10px; display:none; gap:10px; z-index:var(--z-hud); pointer-events:none}
    .hud-group{pointer-events:auto; flex:1; display:flex; gap:18px; justify-content:space-between; background:rgba(18,24,37,.85); border:1px solid var(--brd); border-radius:var(--r-md); padding:10px 14px}
    .hud-stat{display:flex; flex-direction:column; align-items:center; gap:2px}
    .hud-label{font-size:11px; color:var(--text-3)}
    .hud-value{font-family:var(--font-mono); font-weight:700}
    #comboCounter{position:absolute; top:72%; left:50%; transform:translateX(-50%); font-family:var(--font-display); font-weight:700; color:var(--warn); text-shadow:0 0 20px rgba(245,158,11,.8); z-index:150; opacity:0; transition:.2s}
    #missileButton{width:72px; height:72px; position:fixed; bottom:28px; right:18px; z-index:var(--z-hud); border-radius:var(--r-full); border:2px solid rgba(239,68,68,.5); background:var(--bad); color:#fff; font-weight:700; cursor:pointer; display:none; align-items:center; justify-content:center; gap:4px}
    #missileButton::before{content:'ðŸš€'; font-size:22px}
    #missileButton:hover{transform:scale(1.04)} #missileButton:active{transform:scale(.96)}
    /* Lower-quadrant menu */
    #menu{position:absolute; left:50%; bottom:6%; transform:translateX(-50%); width:90%; max-width:520px; display:flex; flex-direction:column; gap:10px; align-items:center; z-index:var(--z-menu); text-align:center}
    .button{background:var(--accent); color:#03222a; border:none; border-radius:var(--r-md); padding:10px 18px; font-weight:700; cursor:pointer}
    .button:hover{background:var(--accent-2)} .button-secondary{background:var(--bg-2); color:var(--text); border:1px solid var(--brd)} .button-secondary:hover{border-color:var(--accent)}
    .difficulty-buttons{display:flex; gap:8px; margin-top:6px}
    .interstitial-screen{position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); width:calc(100% - 48px); max-width:640px; background:var(--bg-2); border-radius:var(--r-lg); border:1px solid var(--brd); padding:24px; display:none; flex-direction:column; gap:16px; z-index:var(--z-modal); box-shadow:0 20px 30px rgba(0,0,0,.35)}
    #shop{padding:24px} .shop-header{display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--brd); padding-bottom:14px}
    .shop-balance{font-family:var(--font-mono); font-weight:700; color:var(--warn); display:flex; align-items:center; gap:8px}
    .shop-balance::before{content:'ðŸ’°'}
    .shop-tabs{display:flex; gap:8px; margin:14px 0} .tab{padding:8px 14px; border:1px solid var(--brd); border-radius:var(--r-md); background:transparent; color:var(--text-2); cursor:pointer}
    .tab.active{border-color:var(--accent); color:var(--accent); background:rgba(34,211,238,.08)}
    .shop-items{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; max-height:50vh; overflow:auto}
    .item-card{background:var(--bg-3); border:1px solid var(--brd); border-radius:var(--r-md); padding:10px; text-align:center}
    .item-card.equipped{border-color:var(--good); box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .item-sprite{width:100px; height:100px; object-fit:contain; image-rendering:pixelated; background:#000; border-radius:6px; margin:auto}
    /* Victory art keeps rectangle */
    .album-art{display:block; width:min(90vw,900px); height:auto; border-radius:10px; margin:10px auto; box-shadow:0 10px 24px rgba(0,0,0,.4)}
    #audioControls{position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:var(--z-audio)}
    .audio-btn{width:42px; height:42px; border-radius:var(--r-full); background:var(--bg-2); border:1px solid var(--brd); display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px}
    #muteBtn::before{content:'ðŸ”Š'} #muteBtn.muted::before{content:'ðŸ”‡'} .audio-btn.muted{background:rgba(239,68,68,.12); color:var(--bad); border-color:rgba(239,68,68,.35)}
  </style>
</head>
<body>
  <div id="audioControls" style="display:flex;"><button id="muteBtn" class="audio-btn" title="Toggle Sound"></button></div>
  <canvas id="gameCanvas"></canvas>
  <img id="titleImage" src="assets/gametitle.jpg" alt="Earth Defender" />

  <!-- HUD -->
  <div id="hud">
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Wave</span><span id="waveDisplay" class="hud-value">1</span></div>
      <div class="hud-stat"><span class="hud-label">Score</span><span id="scoreDisplay" class="hud-value">0</span></div>
    </div>
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Lives</span><span id="livesDisplay" class="hud-value">3</span></div>
      <div class="hud-stat"><span class="hud-label">Coins</span><span id="coinsDisplay" class="hud-value">100</span></div>
      <div class="hud-stat"><span class="hud-label">Missiles</span><span id="missilesDisplay" class="hud-value">3</span></div>
    </div>
  </div>

  <div id="comboCounter"></div>
  <button id="missileButton" onclick="if(window.Game){ Game.launchMissile(); }">Fire</button>

  <!-- Menu (lower quadrant) -->
  <div id="menu">
    <button class="button" onclick="if(window.Game){ Game.startGame('normal'); }">Start</button>
    <button class="button button-secondary" onclick="if(window.Game){ Game.showShop(); }">Shop</button>
    <button class="button button-secondary" onclick="if(window.Game){ Game.showTutorial(); }">Help</button>
    <div class="difficulty-buttons">
      <button class="button" onclick="if(window.Game){ Game.startGame('easy'); }">Easy</button>
      <button class="button" onclick="if(window.Game){ Game.startGame('normal'); }">Normal</button>
      <button class="button" onclick="if(window.Game){ Game.startGame('hard'); }">Hard</button>
    </div>
  </div>

  <!-- Shop -->
  <div id="shop" class="interstitial-screen">
    <div class="shop-header">
      <h2>Upgrades</h2>
      <div style="display:flex; align-items:center; gap:12px;">
        <span id="shopBalance" class="shop-balance">100</span>
        <button class="button button-secondary" onclick="if(window.Game){ Game.closeShop(); }">Close</button>
      </div>
    </div>
    <div class="shop-tabs">
      <button class="tab active" onclick="if(window.Game){ Game.switchTab('weapons', event); }">Weapons</button>
      <button class="tab" onclick="if(window.Game){ Game.switchTab('shields', event); }">Shields</button>
      <button class="tab" onclick="if(window.Game){ Game.switchTab('systems', event); }">Systems</button>
    </div>
    <div id="shopItems" class="shop-items"></div>
  </div>

  <!-- Wave choice -->
  <div id="waveChoice" class="interstitial-screen">
    <h2>Choose Your Upgrade</h2>
    <p>Pick one to power up for the next wave.</p>
    <div id="choiceCards" class="choice-cards"></div>
  </div>

  <!-- Wave transition -->
  <div id="waveTransition" class="interstitial-screen">
    <h2>Wave Complete!</h2>
    <p>Prepare for the next assault.</p>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button class="button" onclick="if(window.Game){ Game.resumeGame(); }">Next Wave</button>
      <button class="button button-secondary" onclick="if(window.Game){ Game.showInGameShop(); }">Visit Shop</button>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorial" class="interstitial-screen">
    <h2>How to Play</h2>
    <p>
      <strong>Objective:</strong> Defend Earth by destroying all incoming enemy ships before they reach the planet.<br><br>
      <strong>Controls:</strong> Rotate with mouse (desktop) or vertical swipe (mobile). Firing is automatic.<br><br>
      <strong>Missiles:</strong> Tap the missile button for a homing missile.<br><br>
      <strong>Upgrades:</strong> Choose a temporary bonus after each wave; buy permanent upgrades in the shop.
    </p>
    <div style="text-align:center;"><button class="button" onclick="if(window.Game){ Game.closeTutorial(); }">Back to Menu</button></div>
  </div>

  <!-- Pause -->
  <div id="pauseScreen" class="interstitial-screen" style="max-width:420px;">
    <h2>Paused</h2><p style="text-align:center;">Press ESC to resume</p>
  </div>

  <!-- Death -->
  <div id="deathScreen" class="interstitial-screen">
    <h2>Mission Failed</h2>
    <div id="deathStats" class="death-stats"></div>
    <div id="deathRecommendation" class="death-recommendation"></div>
    <button class="button" onclick="if(window.Game){ Game.closeDeathScreen(); }">Continue</button>
  </div>

  <!-- Victory -->
  <div id="victoryScreen" class="interstitial-screen">
    <h2>Victory!</h2>
    <img src="assets/IMG_1538.PNG" class="album-art" alt="Oh Death Album Art">
    <div class="credits-text" style="text-align:center">
      <p><strong>Game Design</strong><br>D_York</p>
      <p><strong>Original Music by D_York</strong><br>Represented by United Masters</p>
      <p>Available on <a href="https://unitedmasters.com/m/oh-death-1" target="_blank" rel="noopener">Spotify &amp; Apple Music</a></p>
    </div>
    <button class="button" onclick="if(window.Game){ Game.closeVictoryScreen(); }">Main Menu</button>
  </div>

  <script>
  'use strict';

  /* ---------------- Audio ---------------- */
  function AudioManager(){
    this.ctx=null; this.music={}; this.current=null; this.muted=false;
    this.musicVol=0.45; this.sfxVol=0.6;
    this.playlists={
      menu:['assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'],
      gameplay:[
        'assets/audio/m33_-_4_26_25__11_13_AM.m4a',
        'assets/audio/MIAMI__mret_-_5_27_24__5_09_PM_.m4a',
        'assets/audio/goodroots - 1_17_25, 9.41 PM.m4a',
        'assets/audio/newleed - 9_28_24, 6.48 PM.m4a',
        'assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'
      ],
      boss:['assets/audio/monster.mp3','assets/audio/dumplin_-_7_6_24__8_51_PM.m4a'],
      victory:['assets/audio/propane2 - 12_21_24, 10.27 AM.m4a'],
      gameover:['assets/audio/gameover.mp3']
    };
    this.queue=[]; this.idx=0;

    try{
      this.ctx = (window.AudioContext||window.webkitAudioContext) ? new (window.AudioContext||window.webkitAudioContext)() : null;
    }catch(e){ this.ctx=null; }

    var btn=document.getElementById('muteBtn');
    if(btn){
      var self=this;
      btn.addEventListener('click', function(){ self.toggleMute(); });
    }

    // preload tags
    var k, list;
    for(k in this.playlists){
      list=this.playlists[k];
      for(var i=0;i<list.length;i++){
        var src=list[i]; if(!this.music[src]){
          var a=new Audio(src); a.preload='auto'; a.loop=false; a.volume=0; a.load(); this.music[src]=a;
        }
      }
    }
  }
  AudioManager.prototype.kick=function(){
    if(this.ctx && this.ctx.state==='suspended'){ this.ctx.resume().catch(function(){}); }
    if(!this.current || this.current.paused){ this.playMusic('menu',800); }
  };
  AudioManager.prototype.toggleMute=function(){
    this.muted=!this.muted; var btn=document.getElementById('muteBtn');
    if(btn){ btn.classList.toggle('muted', this.muted); }
    if(this.current){ this.current.volume=this.muted?0:this.musicVol; }
  };
  AudioManager.prototype.playMusic=function(name,fade){
    fade=fade||1200; var list=this.playlists[name]||[]; if(!list.length) return;
    this.queue=list.slice(); if(name==='menu'||name==='gameplay') this.shuffle(this.queue);
    this.idx=0; this.playTrack(this.queue[this.idx], fade, (name==='menu'||name==='gameplay'));
  };
  AudioManager.prototype.playTrack=function(src,fade,chain){
    var next=this.music[src]; if(!next) return;
    for(var key in this.music){ var a=this.music[key]; if(a && a!==next){ a.pause(); a.currentTime=0; a.volume=0; a.onended=null; } }
    if(this.current){ this.fadeOut(this.current, fade); }
    this.current=next; next.currentTime=0;
    var self=this;
    next.play().then(function(){ self.fadeIn(next, fade, self.muted?0:self.musicVol); }).catch(function(){});
    if(chain){ next.loop=false; next.onended=function(){ self.idx=(self.idx+1)%self.queue.length; self.playTrack(self.queue[self.idx],800,true); }; }
    else{ next.loop=true; next.onended=null; }
  };
  AudioManager.prototype.fadeIn=function(a,dur,target){
    if(!a) return; var steps=30, dt=dur/steps, inc=target/steps, i=0; a.volume=0;
    var id=setInterval(function(){ if(!a){ clearInterval(id); return; } if(i++>=steps){ a.volume=target; clearInterval(id); return; } a.volume = (a.volume+inc); }, dt);
  };
  AudioManager.prototype.fadeOut=function(a,dur){
    if(!a) return; var steps=30, dt=dur/steps, dec=(a.volume||0)/steps, i=0;
    var id=setInterval(function(){ if(!a){ clearInterval(id); return; } if(i++>=steps){ a.pause(); a.volume=0; clearInterval(id); return; } a.volume=Math.max(0,a.volume-dec); }, dt);
  };
  AudioManager.prototype.shuffle=function(arr){ for(var i=arr.length-1;i>0;i--){ var j=Math.floor(Math.random()*(i+1)); var t=arr[i]; arr[i]=arr[j]; arr[j]=t; } };
  AudioManager.prototype.sfx=function(type){
    if(!this.ctx || this.muted) return;
    var ctx=this.ctx, now=ctx.currentTime;
    function tone(f,t,g,typ){ t=t||.1; g=g||.3; typ=typ||'sine'; var o=ctx.createOscillator(), gain=ctx.createGain();
      o.type=typ; o.frequency.setValueAtTime(f, now); o.connect(gain); gain.connect(ctx.destination);
      gain.gain.setValueAtTime(g, now); gain.gain.exponentialRampToValueAtTime(0.01, now+t); o.start(now); o.stop(now+t); }
    if(type==='shoot') tone(220,.08,.25,'square');
    if(type==='hit') tone(140,.05,.35,'sawtooth');
    if(type==='missile'){ tone(440,.25,.3,'sawtooth'); var self=this; setTimeout(function(){ self.sfx('explosion'); },300); }
    if(type==='explosion'){ for(var i=0;i<4;i++){ (function(i){ setTimeout(function(){ tone(80+Math.random()*60,.12,.35,'triangle'); },i*40); })(i); } }
    if(type==='upgrade'){ var freqs=[440,554,659,880]; for(var j=0;j<freqs.length;j++){ (function(j){ setTimeout(function(){ tone(freqs[j],.25,.24,'sine'); }, j*110); })(j); } }
    if(type==='warning'){ var ff=[440,554,440]; for(var k=0;k<ff.length;k++){ (function(k){ setTimeout(function(){ tone(ff[k],.15,.3,'square'); }, k*180); })(k); } }
    if(type==='bossHit') tone(120,.2,.45,'square');
    if(type==='wave'){ var wf=[523,659,784,1047]; for(var m=0;m<wf.length;m++){ (function(m){ setTimeout(function(){ tone(wf[m],.35,.3,'sine'); }, m*150); })(m); } }
  };

  /* ---------------- Game ---------------- */
  function initializeGame(){
    var canvas=document.getElementById('gameCanvas');
    var ctx=canvas.getContext('2d');

    var bgImg=new Image(); bgImg.src='assets/background.png'; var bgInfo=null, bgLoaded=false;
    bgImg.onload=function(){ bgLoaded=true; resize(); };

    var shipImg=new Image(); shipImg.src='assets/player-ship.jpg'; var shipLoaded=false; shipImg.onload=function(){ shipLoaded=true; };
    var shipDam=new Image(); shipDam.src='assets/player-ship-damaged.jpg'; var shipDamLoaded=false; shipDam.onload=function(){ shipDamLoaded=true; };

    var bossProj=new Image(); bossProj.src='assets/IMG_1439_2.JPG';

    var audio=new AudioManager();

    var CFG={ ORBIT_R:60, SHIELD_R:70, EARTH_COLLIDE_R:45, EARTH_IMPACT_R:35, ENEMY_HIT_R:25, BOSS_HIT_R:80, SHIP_SIZE:58, MAX_WAVES:20 };

    var visualEarthX=0, visualEarthY=0;
    var wave=1, score=0, lives=3, coins=100, missiles=3;
    var gameRunning=false, paused=false;
    var shipAngle=0, targetAngle=0;
    var lastT=performance.now();

    var enemies=[], projectiles=[], missilesArr=[], bossShots=[];

    var shopItems={
      weapons:[
        {id:'basic', name:'Basic Cannon', cost:0, damage:1, fireRate:400, desc:'Standard issue.', sprite:'assets/IMG_1426_2.jpg'},
        {id:'spread', name:'Spread Shot', cost:250, damage:0.8, fireRate:450, desc:'5-way fan.', pattern:'spread', sprite:'assets/IMG_1405_2.jpg'},
        {id:'piercing', name:'Rail Gun', cost:500, damage:5, fireRate:1000, desc:'Pierces enemies.', beam:true, piercing:true, sprite:'assets/IMG_1408_2.jpg'},
        {id:'rapid', name:'Rapid Fire', cost:800, damage:0.5, fireRate:100, desc:'Bullet stream.', rapid:true, sprite:'assets/IMG_1403_2.jpg'},
        {id:'burst', name:'Burst Cannon', cost:1200, damage:1.5, fireRate:600, desc:'3-shot bursts.', burst:3, sprite:'assets/IMG_1404_2.jpg'},
        {id:'plasma', name:'Plasma Wave', cost:2000, damage:3, fireRate:800, desc:'Expanding wave.', wave:true, sprite:'assets/IMG_1429_2.jpg'}
      ],
      shields:[
        {id:'basic', name:'Energy Shield', cost:300, health:100, desc:'Absorbs 100.', sprite:'assets/IMG_1424_2.jpg'},
        {id:'regen', name:'Regen Shield', cost:700, health:80, regen:2, desc:'+2 HP/s.', sprite:'assets/IMG_1423_2.jpg'}
      ],
      systems:[
        {id:'speed', name:'Thrusters', cost:300, speedBoost:1.5, desc:'+50% turn speed.', sprite:'assets/IMG_1422_2.jpg'},
        {id:'auto', name:'Auto-Targeter', cost:600, autoTarget:true, desc:'Aims at nearest.', sprite:'assets/IMG_1416_2.jpg'}
      ]
    };
    var gameState={ equipment:{weapon:'basic', shield:null, system:null}, owned:{weapons:['basic'], shields:[], systems:[]}, maxShieldHealth:0, shieldHealth:0, temporaryUpgrades:[] };

    function $(id){ return document.getElementById(id); }
    function updateUI(){
      var w=$('waveDisplay'), s=$('scoreDisplay'), l=$('livesDisplay'), c=$('coinsDisplay'), m=$('missilesDisplay'), b=$('shopBalance');
      if(w) w.textContent=wave; if(s) s.textContent=score; if(l) l.textContent=lives; if(c) c.textContent=coins; if(m) m.textContent=missiles; if(b) b.textContent=coins;
    }

    function resize(){
      canvas.width=innerWidth; canvas.height=innerHeight;
      if(bgLoaded && bgImg.width){
        var cw=canvas.width, ch=canvas.height, ca=cw/ch, ia=bgImg.width/bgImg.height;
        var dw,dh,ox,oy;
        if(ca>ia){ dw=cw; dh=dw/ia; ox=0; oy=(ch-dh)/2; }
        else{ dh=ch; dw=dh*ia; oy=0; ox=(cw-dw)/2; }
        bgInfo={x:ox,y:oy,w:dw,h:dh};
        visualEarthX=ox+dw/2; visualEarthY=oy+dh*0.48;
      }else{ visualEarthX=canvas.width/2; visualEarthY=canvas.height/2; }
    }
    window.addEventListener('resize', resize); resize();

    /* input */
    var dragging=false, touchY=0;
    canvas.addEventListener('mousemove', function(e){ if(!gameRunning||paused) return; var r=canvas.getBoundingClientRect(); targetAngle=Math.atan2(e.clientY-r.top-visualEarthY, e.clientX-r.left-visualEarthX); });
    canvas.addEventListener('touchstart', function(e){ if(!gameRunning||paused) return; dragging=true; touchY=e.touches[0].clientY; }, {passive:true});
    canvas.addEventListener('touchmove', function(e){ if(!gameRunning||paused||!dragging) return; var dy=e.touches[0].clientY-touchY; touchY=e.touches[0].clientY; targetAngle+=dy*0.008; }, {passive:true});
    canvas.addEventListener('touchend', function(){ dragging=false; });
    document.addEventListener('keydown', function(e){
      if(e.key==='Escape'){ paused=!paused; $('pauseScreen').style.display=paused?'flex':'none'; if(paused) audio.playMusic('menu',600); else audio.playMusic(isBossWave()?'boss':'gameplay',800); }
      if(!gameRunning||paused) return;
      if(e.key===' '){ e.preventDefault(); launchMissile(); }
      if(e.key==='a'||e.key==='ArrowLeft') targetAngle-=0.1;
      if(e.key==='d'||e.key==='ArrowRight') targetAngle+=0.1;
    });

    function drawBackground(){ ctx.fillStyle='#0a0e1a'; ctx.fillRect(0,0,canvas.width,canvas.height); if(bgInfo) ctx.drawImage(bgImg,bgInfo.x,bgInfo.y,bgInfo.w,bgInfo.h); }
    function drawShield(){
      if(gameState.shieldHealth>0 && gameState.maxShieldHealth>0){
        var pct=gameState.shieldHealth/gameState.maxShieldHealth;
        ctx.save(); ctx.strokeStyle='rgba(34,211,238,'+(0.15+0.35*pct)+')'; ctx.lineWidth=2.5; ctx.setLineDash([6,6]);
        ctx.beginPath(); ctx.arc(visualEarthX,visualEarthY,70,0,Math.PI*2); ctx.stroke(); ctx.restore(); ctx.setLineDash([]);
      }
    }
    function drawShip(){
      var x=visualEarthX+Math.cos(shipAngle)*60, y=visualEarthY+Math.sin(shipAngle)*60;
      ctx.save(); ctx.translate(x,y); ctx.rotate(shipAngle+Math.PI/2);
      var img=(lives<=2 && shipDamLoaded)? shipDam : (shipLoaded? shipImg : null);
      if(img){ ctx.globalCompositeOperation='lighter'; ctx.drawImage(img,-29,-29,58,58); ctx.globalCompositeOperation='source-over'; }
      else{ ctx.fillStyle='#22d3ee'; ctx.beginPath(); ctx.arc(0,0, 18, 0, Math.PI*2); ctx.fill(); }
      ctx.restore();
    }

    function spawnWave(){
      if(isBossWave()) audio.playMusic('boss',800); else audio.playMusic('gameplay',800);
      enemies.length=0;
      if(isBossWave()){
        var a=Math.random()*Math.PI*2, d=Math.max(canvas.width,canvas.height)*0.7;
        enemies.push({name:'boss', x:visualEarthX+Math.cos(a)*d, y:visualEarthY+Math.sin(a)*d, speed:.6, health:120+wave*18, maxHealth:120+wave*18, coins:200, t:0});
      }else{
        var count=6+(wave-1)*2;
        for(var i=0;i<count;i++){
          var ang=Math.random()*Math.PI*2, dist=Math.max(canvas.width,canvas.height)*0.75;
          enemies.push({name:'enemy', x:visualEarthX+Math.cos(ang)*dist, y:visualEarthY+Math.sin(ang)*dist, speed:.9+Math.random()*.6, health:2+Math.random()*2+wave*.25, maxHealth:3+wave*.25, coins:10+Math.floor(Math.random()*8)});
        }
      }
    }
    function isBossWave(){ return wave>0 && (wave%5===0); }

    function autoFire(dt){
      var id=gameState.equipment.weapon||'basic';
      var w=null, i; for(i=0;i<shopItems.weapons.length;i++){ if(shopItems.weapons[i].id===id){ w=shopItems.weapons[i]; break; } }
      if(!w) w=shopItems.weapons[0];
      autoFire.t=(autoFire.t||0)+dt*1000;
      if(autoFire.t>=(w.fireRate||400)){ autoFire.t=0; fire(w); }
    }
    function fire(w){
      if(!w) return;
      var speed=w.rapid?15:10;
      var sx=visualEarthX+Math.cos(shipAngle)*60, sy=visualEarthY+Math.sin(shipAngle)*60;
      if(w.pattern==='spread'){
        for(var i=-2;i<=2;i++){ var a=shipAngle+i*0.15; projectiles.push({x:sx,y:sy,vx:Math.cos(a)*speed,vy:Math.sin(a)*speed,d:w.damage||1,pierce:!!w.piercing,life:2}); }
      }else{
        projectiles.push({x:sx,y:sy,vx:Math.cos(shipAngle)*speed,vy:Math.sin(shipAngle)*speed,d:w.damage||1,pierce:!!w.piercing,life:2});
      }
      audio.sfx('shoot');
    }

    function launchMissile(){
      if(!gameRunning || missiles<=0) return; missiles--; updateUI(); audio.sfx('missile');
      var sx=visualEarthX+Math.cos(shipAngle)*60, sy=visualEarthY+Math.sin(shipAngle)*60, target=null, best=1e9;
      for(var i=0;i<enemies.length;i++){ var e=enemies[i]; var d=(e.x-sx)*(e.x-sx)+(e.y-sy)*(e.y-sy); if(d<best){ best=d; target=e; } }
      missilesArr.push({x:sx,y:sy,vx:Math.cos(shipAngle)*6,vy:Math.sin(shipAngle)*6,target:target,life:5,damage:10});
    }

    function outOfBounds(x,y){ return x<-150 || x>canvas.width+150 || y<-150 || y>canvas.height+150; }

    function update(dt){
      var diff=Math.atan2(Math.sin(targetAngle-shipAngle), Math.cos(targetAngle-shipAngle)); shipAngle+=diff*0.15;

      /* projectiles */
      var i;
      for(i=projectiles.length-1;i>=0;i--){
        var p=projectiles[i]; p.x+=p.vx*dt*60; p.y+=p.vy*dt*60; p.life-=dt;
        if(p.life<=0 || outOfBounds(p.x,p.y)){ projectiles.splice(i,1); }
      }
      /* missiles */
      for(i=missilesArr.length-1;i>=0;i--){
        var m=missilesArr[i];
        if(m.target && enemies.indexOf(m.target)!==-1){ var a=Math.atan2(m.target.y-m.y, m.target.x-m.x); m.vx=Math.cos(a)*8; m.vy=Math.sin(a)*8; }
        m.x+=m.vx*dt*60; m.y+=m.vy*dt*60; m.life-=dt;
        if(m.life<=0 || outOfBounds(m.x,m.y)){ missilesArr.splice(i,1); }
      }
      /* boss shots */
      for(i=bossShots.length-1;i>=0;i--){
        var b=bossShots[i]; b.x+=b.vx*dt*60; b.y+=b.vy*dt*60; b.rot=(b.rot||0)+dt*5;
        var de=Math.hypot(b.x-visualEarthX,b.y-visualEarthY);
        if(de<45){ if(gameState.shieldHealth>0){ gameState.shieldHealth=Math.max(0,gameState.shieldHealth-10); audio.sfx('warning'); } else { lives--; audio.sfx('warning'); if(lives<=0){ endGame(); return; } } bossShots.splice(i,1); }
        else if(outOfBounds(b.x,b.y)){ bossShots.splice(i,1); }
      }
      /* enemies */
      for(i=enemies.length-1;i>=0;i--){
        var e=enemies[i]; var ang=Math.atan2(visualEarthY-e.y, visualEarthX-e.x); var v=(e.speed||1)*60;
        e.x+=Math.cos(ang)*v*dt; e.y+=Math.sin(ang)*v*dt;
        if(e.name==='boss'){ e.t=(e.t||0)+dt*1000; if(e.t>2200){ e.t=0; var shoot=Math.atan2(visualEarthY-e.y, visualEarthX-e.x)+(Math.random()-.5)*0.5; bossShots.push({x:e.x,y:e.y,vx:Math.cos(shoot)*2,vy:Math.sin(shoot)*2,rot:0}); audio.sfx('shoot'); } }
        var dE=Math.hypot(e.x-visualEarthX, e.y-visualEarthY);
        if(dE<35){ if(gameState.shieldHealth>0){ var dmg=Math.min(gameState.shieldHealth,e.health); gameState.shieldHealth-=dmg; } else { lives--; if(lives<=0){ endGame(); return; } } enemies.splice(i,1); }
      }
      /* collisions bullets vs enemies */
      for(i=projectiles.length-1;i>=0;i--){
        var pi=projectiles[i], hit=false;
        for(var j=enemies.length-1;j>=0;j--){
          var ee=enemies[j], hr=(ee.name==='boss'?80:25);
          if(Math.hypot(pi.x-ee.x, pi.y-ee.y) < hr){
            ee.health -= pi.d; audio.sfx(ee.name==='boss'?'bossHit':'hit'); hit=true;
            if(ee.health<=0){ score += (ee.coins||10)*2; coins += (ee.coins||10); enemies.splice(j,1); audio.sfx('explosion'); }
            if(!pi.pierce){ projectiles.splice(i,1); }
            break;
          }
        }
        if(hit && i>=projectiles.length) i=projectiles.length-1; /* safety after splice */
      }
      /* collisions missiles vs enemies */
      for(i=missilesArr.length-1;i>=0;i--){
        var mi=missilesArr[i], done=false;
        for(var k=0;k<enemies.length;k++){
          var en=enemies[k], r=(en.name==='boss'?80:25);
          if(Math.hypot(mi.x-en.x, mi.y-en.y) < r){
            en.health-=mi.damage; audio.sfx('explosion');
            if(en.health<=0){ score += (en.coins||10)*2; coins += (en.coins||10); enemies.splice(k,1); }
            missilesArr.splice(i,1); done=true; break;
          }
        }
        if(done && i>=missilesArr.length) i=missilesArr.length-1;
      }

      if(gameRunning && enemies.length===0){ if(wave>=CFG.MAX_WAVES){ showVictoryScreen(); return; } wave++; coins+=wave*50; missiles=Math.min(10,missiles+1); updateUI(); showWaveChoice(); }
    }

    function draw(){
      drawBackground(); drawShield(); drawShip();
      var i;
      /* bullets */
      ctx.fillStyle='#22d3ee';
      for(i=0;i<projectiles.length;i++){ var p=projectiles[i]; ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); }
      /* missiles */
      ctx.fillStyle='#ef4444';
      for(i=0;i<missilesArr.length;i++){ var m=missilesArr[i]; ctx.beginPath(); ctx.arc(m.x,m.y,5,0,Math.PI*2); ctx.fill(); }
      /* boss shots */
      for(i=0;i<bossShots.length;i++){ var b=bossShots[i]; ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.rot||0);
        if(bossProj.complete && bossProj.naturalWidth){ ctx.drawImage(bossProj,-15,-15,30,30); } else { ctx.fillStyle='#f00'; ctx.fillRect(-10,-10,20,20); }
        ctx.restore();
      }
      /* enemies */
      for(i=0;i<enemies.length;i++){
        var e=enemies[i], sz=(e.name==='boss'?160:50);
        ctx.save(); ctx.translate(e.x,e.y); ctx.fillStyle=(e.name==='boss')?'#ff4d4d':'#f59e0b'; ctx.beginPath(); ctx.arc(0,0,sz/2,0,Math.PI*2); ctx.fill();
        var pct=Math.max(0, Math.min(1, e.health/e.maxHealth)), w=sz*.8, h=6;
        ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(-w/2, -sz/2-14, w, h);
        ctx.fillStyle= pct>0.3? '#10b981' : '#ef4444'; ctx.fillRect(-w/2, -sz/2-14, w*pct, h); ctx.restore();
      }
    }

    /* screens & shop */
    function showShop(){ if($('menu').style.display!=='none'||$('deathScreen').style.display!=='none') shopReturn='menu'; $('menu').style.display='none'; $('deathScreen').style.display='none'; $('shop').style.display='flex'; renderShop('weapons'); }
    function closeShop(){ $('shop').style.display='none'; if(shopReturn==='in_game'){ $('waveTransition').style.display='flex'; } else { $('menu').style.display='block'; } }
    function showInGameShop(){ shopReturn='in_game'; $('waveTransition').style.display='none'; showShop(); }
    function showTutorial(){ $('menu').style.display='none'; $('tutorial').style.display='flex'; }
    function closeTutorial(){ $('tutorial').style.display='none'; $('menu').style.display='block'; }
    function switchTab(tabName, ev){ var tabs=document.querySelectorAll('.tab'); for(var i=0;i<tabs.length;i++) tabs[i].classList.remove('active'); if(ev&&ev.currentTarget) ev.currentTarget.classList.add('active'); renderShop(tabName); }
    function renderShop(cat){
      var box=$('shopItems'); if(!box) return; box.innerHTML='';
      var key= cat==='weapons'?'weapon' : (cat==='shields'?'shield':'system');
      var arr=shopItems[cat]||[];
      for(var i=0;i<arr.length;i++){
        var item=arr[i], owned=(gameState.owned[cat]||[]).indexOf(item.id)!==-1, equipped=(gameState.equipment[key]===item.id), can=coins>=item.cost;
        var card=document.createElement('div'); card.className='item-card'+(equipped?' equipped':'');
        card.innerHTML='<img src="'+item.sprite+'" class="item-sprite" alt="'+item.name+'" onerror="this.style.display=\'none\'">'+
                       '<div class="item-name" style="color:var(--accent); font-weight:700">'+item.name+'</div>'+
                       '<div class="item-desc" style="font-size:.8rem; color:var(--text-2)">'+(item.desc||'')+'</div>'+
                       '<div class="item-price" style="font-family:var(--font-mono); color:var(--warn)">'+(item.cost>0?('ðŸ’° '+item.cost):'Free')+'</div>'+
                       (equipped?'<div style="color:var(--good); font-size:.8rem; font-weight:700">Equipped</div>':'');
        if(!owned && item.cost>0){
          var buy=document.createElement('button'); buy.className='button'; buy.textContent= can?'Buy':'Not enough coins'; buy.disabled=!can; buy.onclick=(function(cat,id){ return function(){ buyItem(cat,id); }; })(cat,item.id); card.appendChild(buy);
        }else if(!equipped){
          var eq=document.createElement('button'); eq.className='button'; eq.textContent='Equip'; eq.onclick=(function(cat,id){ return function(){ equipItem(cat,id); }; })(cat,item.id); card.appendChild(eq);
        }
        box.appendChild(card);
      }
    }
    function buyItem(cat,id){ var arr=shopItems[cat]||[]; var item=null; for(var i=0;i<arr.length;i++){ if(arr[i].id===id){ item=arr[i]; break; } } if(!item||coins<item.cost) return; coins-=item.cost; if(!gameState.owned[cat]) gameState.owned[cat]=[]; gameState.owned[cat].push(id); updateUI(); renderShop(cat); }
    function equipItem(cat,id){ var key=cat==='weapons'?'weapon':(cat==='shields'?'shield':'system'); gameState.equipment[key]=id; if(cat==='shields'){ var sh=null, i; for(i=0;i<shopItems.shields.length;i++){ if(shopItems.shields[i].id===id){ sh=shopItems.shields[i]; break; } } gameState.maxShieldHealth=sh&&sh.health||0; gameState.shieldHealth=sh&&sh.health||0; } renderShop(cat); }

    function showWaveChoice(){
      gameRunning=false; $('waveChoice').style.display='flex'; var list=$('choiceCards'); list.innerHTML='';
      var choices=[{name:'Fire Rate Boost',type:'fireRate',value:.8,effect:'+20% fire rate'},{name:'Damage Boost',type:'damage',value:1.5,effect:'+50% damage'},{name:'Missiles+',type:'missiles',value:3,effect:'+3 missiles'}];
      for(var i=0;i<choices.length;i++){ (function(ch){ var card=document.createElement('div'); card.className='item-card';
        card.innerHTML='<div class="choice-card-name" style="color:var(--accent); font-weight:700">'+ch.name+'</div>'+
                       '<div class="choice-card-desc" style="color:var(--text-2)">Temporary bonus for the next wave.</div>'+
                       '<div class="choice-card-effect" style="color:var(--good); font-weight:700">'+ch.effect+'</div>';
        card.onclick=function(){ selectWaveChoice(ch); }; list.appendChild(card); })(choices[i]); }
    }
    function selectWaveChoice(ch){ if(ch.type==='missiles'){ missiles+=ch.value; } else { gameState.temporaryUpgrades.push(ch); } $('waveChoice').style.display='none'; $('waveTransition').style.display='flex'; }
    function resumeGame(){ $('waveTransition').style.display='none'; gameRunning=true; spawnWave(); }

    function startGame(){
      $('menu').style.display='none'; var t=$('titleImage'); if(t) t.style.display='none'; $('hud').style.display='flex'; $('missileButton').style.display='flex';
      gameRunning=true; paused=false; wave=1; score=0; lives=3; missiles=3; enemies.length=0; projectiles.length=0; missilesArr.length=0; bossShots.length=0; updateUI(); spawnWave(); audio.playMusic('gameplay',800);
    }
    function endGame(){ audio.playMusic('gameover',600); gameRunning=false; $('hud').style.display='none'; $('missileButton').style.display='none'; showDeath(); }
    function showDeath(){ var stats=$('deathStats'), rec=$('deathRecommendation'); if(stats){ stats.innerHTML='<div class="death-stat-row"><span>Waves Survived</span><span>'+(wave-1)+'</span></div><div class="death-stat-row"><span>Enemies Killed</span><span>'+0+'</span></div><div class="death-stat-row"><span>Final Score</span><span>'+score+'</span></div><div class="death-stat-row"><span>Coins Earned</span><span>'+coins+'</span></div>'; } if(rec) rec.textContent='Try upgrading your weapon or shield.'; $('deathScreen').style.display='flex'; }
    function closeDeathScreen(){ audio.playMusic('menu',600); $('deathScreen').style.display='none'; $('menu').style.display='block'; var t=$('titleImage'); if(t) t.style.display='block'; }
    function showVictoryScreen(){ audio.playMusic('victory',600); gameRunning=false; $('hud').style.display='none'; $('missileButton').style.display='none'; $('victoryScreen').style.display='flex'; }
    function closeVictoryScreen(){ audio.playMusic('menu',600); $('victoryScreen').style.display='none'; $('menu').style.display='block'; var t=$('titleImage'); if(t) t.style.display='block'; }

    function loop(now){ requestAnimationFrame(loop); if(paused){ drawBackground(); drawShield(); drawShip(); return; } var dt=Math.min((now-lastT)/1000,0.017); lastT=now; if(gameRunning){ update(dt); autoFire(dt); } draw(); }

    updateUI(); audio.playMusic('menu',800); requestAnimationFrame(loop);
    var firstGesture=function(){ audio.kick(); window.removeEventListener('pointerdown', firstGesture); window.removeEventListener('keydown', firstGesture); };
    window.addEventListener('pointerdown', firstGesture, {once:true}); window.addEventListener('keydown', firstGesture, {once:true});

    return {
      kickAudio:function(){ audio.kick(); },
      startGame:startGame, resumeGame:resumeGame, launchMissile:launchMissile,
      showShop:showShop, closeShop:closeShop, showInGameShop:showInGameShop,
      showTutorial:showTutorial, closeTutorial:closeTutorial,
      closeDeathScreen:closeDeathScreen, closeVictoryScreen:closeVictoryScreen,
      switchTab:switchTab, setDifficulty:function(d){ /* placeholder */ }
    };
  }

  /* ------------- Boot ------------- */
  window.addEventListener('DOMContentLoaded', function(){
    try{ window.Game = initializeGame(); }catch(e){ console.error('Init error:', e); }
    var selectors=['#startBtn','#playButton','#menuStart','#beginBtn','#start','#play','.start','.play'];
    function act(){ if(window.Game){ Game.startGame('normal'); Game.kickAudio(); var o=document.getElementById('tapToStart'); if(o) o.style.display='none'; } }
    for(var i=0;i<selectors.length;i++){ var list=document.querySelectorAll(selectors[i]); for(var j=0;j<list.length;j++){ list[j].addEventListener('click', act); } }
    var kick=function(){ if(window.Game){ Game.kickAudio(); } };
    window.addEventListener('pointerdown', kick, {once:true}); window.addEventListener('keydown', kick, {once:true});
  });
  </script>
</body>
</html>
