<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <title>Earth Defender</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&family=Space+Grotesk:wght@600;700&family=JetBrains+Mono:wght@500;600&display=swap');

    :root{
      --font-primary:'Inter',system-ui,-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;
      --font-display:'Space Grotesk','Inter',sans-serif;
      --font-mono:'JetBrains Mono','Courier New',monospace;

      --bg:#0a0e1a;
      --bg-2:#121825;
      --bg-3:#1a2332;
      --accent:#22d3ee;
      --accent-2:#06b6d4;
      --good:#10b981;
      --warn:#f59e0b;
      --bad:#ef4444;
      --text:#f8fafc;
      --text-2:#cbd5e1;
      --text-3:#64748b;
      --brd:rgba(255,255,255,.1);

      --r-sm:6px; --r-md:10px; --r-lg:14px; --r-full:9999px;

      --z-hud:100; --z-menu:200; --z-title:201; --z-wave:250; --z-modal:400; --z-audio:1000;
    }

    *{box-sizing:border-box; margin:0; padding:0; -webkit-tap-highlight-color:transparent}
    html,body{height:100%; overflow:hidden; background:var(--bg); color:var(--text); font-family:var(--font-primary)}

    /* CANVAS */
    #gameCanvas{position:fixed; inset:0; width:100vw; height:100vh; image-rendering:pixelated; display:block; background:var(--bg)}

    /* TITLE */
    #titleImage{
      position:absolute; top:25%; left:50%; transform:translate(-50%,-50%);
      width:min(90vw,400px); z-index:var(--z-title); mix-blend-mode:lighten; opacity:.95
    }

    /* HUD */
    #hud{position:fixed; top:10px; left:10px; right:10px; display:flex; gap:10px; z-index:var(--z-hud); pointer-events:none}
    .hud-group{pointer-events:auto; flex:1; display:flex; gap:18px; justify-content:space-between;
      background:rgba(18,24,37,.85); border:1px solid var(--brd); border-radius:var(--r-md); padding:10px 14px}
    .hud-stat{display:flex; flex-direction:column; align-items:center; gap:2px; min-width:0}
    .hud-label{font-size:11px; color:var(--text-3)}
    .hud-value{font-family:var(--font-mono); font-weight:700}

    /* COMBO */
    #comboCounter{position:absolute; top:72%; left:50%; transform:translateX(-50%);
      font-family:var(--font-display); font-weight:700; color:var(--warn); text-shadow:0 0 20px rgba(245,158,11,.8);
      z-index:150; opacity:0; transition:.2s}

    /* MISSILE BTN */
    #missileButton{
      width:72px; height:72px; position:fixed; bottom:28px; right:18px; z-index:var(--z-hud);
      border-radius:var(--r-full); border:2px solid rgba(239,68,68,.5); background:var(--bad);
      color:#fff; font-weight:700; cursor:pointer; display:none; align-items:center; justify-content:center; gap:4px
    }
    #missileButton::before{content:'ðŸš€'; font-size:22px; line-height:1}
    #missileButton:hover{transform:scale(1.04)}
    #missileButton:active{transform:scale(.96)}

    /* MENU (anchored to lower quadrant) */
    #menu{
      position:absolute; left:50%; bottom:6%; transform:translateX(-50%);
      width:90%; max-width:520px; display:flex; flex-direction:column; gap:10px; align-items:center;
      z-index:var(--z-menu); text-align:center
    }
    .button{background:var(--accent); color:#03222a; border:none; border-radius:var(--r-md);
      padding:10px 18px; font-weight:700; cursor:pointer}
    .button:hover{background:var(--accent-2)}
    .button-secondary{background:var(--bg-2); color:var(--text); border:1px solid var(--brd)}
    .button-secondary:hover{border-color:var(--accent)}

    .difficulty-buttons{display:flex; gap:8px; margin-top:6px}
    .difficulty-buttons .button{min-width:88px}

    /* INTERSTITIALS */
    .interstitial-screen{
      position:absolute; top:50%; left:50%; transform:translate(-50%,-50%);
      width:calc(100% - 48px); max-width:640px; background:var(--bg-2); border-radius:var(--r-lg);
      border:1px solid var(--brd); padding:24px; display:none; flex-direction:column; gap:16px;
      z-index:var(--z-modal); box-shadow:0 20px 30px rgba(0,0,0,.35)
    }
    .interstitial-screen h2{font-family:var(--font-display); color:var(--accent)}

    /* SHOP */
    #shop{padding:24px}
    .shop-header{display:flex; align-items:center; justify-content:space-between; gap:12px; border-bottom:1px solid var(--brd); padding-bottom:14px}
    .shop-balance{font-family:var(--font-mono); font-weight:700; color:var(--warn); display:flex; align-items:center; gap:8px}
    .shop-balance::before{content:'ðŸ’°'}
    .shop-tabs{display:flex; gap:8px; margin:14px 0}
    .tab{padding:8px 14px; border:1px solid var(--brd); border-radius:var(--r-md); background:transparent; color:var(--text-2); cursor:pointer}
    .tab.active{border-color:var(--accent); color:var(--accent); background:rgba(34,211,238,.08)}
    .shop-items{display:grid; grid-template-columns:repeat(auto-fill,minmax(160px,1fr)); gap:12px; max-height:50vh; overflow:auto}
    .item-card{background:var(--bg-3); border:1px solid var(--brd); border-radius:var(--r-md); padding:10px; text-align:center}
    .item-card.equipped{border-color:var(--good); box-shadow:0 0 0 2px rgba(16,185,129,.25)}
    .item-sprite{width:100px; height:100px; object-fit:contain; image-rendering:pixelated; background:#000; border-radius:6px; margin:auto}

    /* WAVE CHOICE/TRANSITION */
    .choice-cards{display:grid; grid-template-columns:repeat(auto-fit,minmax(220px,1fr)); gap:12px}

    /* DEATH */
    #deathScreen{border:2px solid var(--bad)}
    #deathScreen h2{color:var(--bad)}
    .death-stats{display:flex; flex-direction:column; gap:8px}
    .death-stat-row{display:flex; justify-content:space-between; border-bottom:1px solid var(--brd); padding:4px 0}

    /* VICTORY â€“ album art keeps aspect ratio */
    #victoryScreen{border:2px solid var(--good)}
    .album-art{
      display:block; width:min(90vw,900px); height:auto; /* preserves rectangle */
      border-radius:10px; margin:10px auto; box-shadow:0 10px 24px rgba(0,0,0,.4)
    }
    .credits-text{text-align:center}

    /* AUDIO BTN */
    #audioControls{position:absolute; top:12px; right:12px; display:flex; gap:8px; z-index:var(--z-audio)}
    .audio-btn{width:42px; height:42px; border-radius:var(--r-full); background:var(--bg-2); border:1px solid var(--brd);
      display:flex; align-items:center; justify-content:center; cursor:pointer; font-size:20px}
    #muteBtn::before{content:'ðŸ”Š'}
    #muteBtn.muted::before{content:'ðŸ”‡'}
    .audio-btn.muted{background:rgba(239,68,68,.12); color:var(--bad); border-color:rgba(239,68,68,.35)}

    @media (max-width:768px){
      #hud{gap:8px}
      .hud-group{gap:12px; padding:8px 10px}
    }
  </style>
</head>
<body>
  <!-- Audio Controls -->
  <div id="audioControls" style="display:flex;">
    <button id="muteBtn" class="audio-btn" title="Toggle Sound"></button>
  </div>

  <!-- Canvas -->
  <canvas id="gameCanvas"></canvas>
  <img id="titleImage" src="assets/gametitle.jpg" alt="Earth Defender" />

  <!-- HUD -->
  <div id="hud" style="display:none;">
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Wave</span><span id="waveDisplay" class="hud-value">1</span></div>
      <div class="hud-stat"><span class="hud-label">Score</span><span id="scoreDisplay" class="hud-value">0</span></div>
    </div>
    <div class="hud-group">
      <div class="hud-stat"><span class="hud-label">Lives</span><span id="livesDisplay" class="hud-value">3</span></div>
      <div class="hud-stat"><span class="hud-label">Coins</span><span id="coinsDisplay" class="hud-value">100</span></div>
      <div class="hud-stat"><span class="hud-label">Missiles</span><span id="missilesDisplay" class="hud-value">3</span></div>
    </div>
  </div>

  <div id="comboCounter"></div>
  <button id="missileButton" onclick="window.Game && Game.launchMissile()">Fire</button>

  <!-- Main Menu (lower quadrant) -->
  <div id="menu">
    <button class="button" onclick="window.Game && Game.startGame('normal')">Start</button>
    <button class="button button-secondary" onclick="window.Game && Game.showShop()">Shop</button>
    <button class="button button-secondary" onclick="window.Game && Game.showTutorial()">Help</button>
    <div class="difficulty-buttons">
      <button class="button" onclick="window.Game && Game.startGame('easy')">Easy</button>
      <button class="button" onclick="window.Game && Game.startGame('normal')">Normal</button>
      <button class="button" onclick="window.Game && Game.startGame('hard')">Hard</button>
    </div>
  </div>

  <!-- Shop -->
  <div id="shop" class="interstitial-screen">
    <div class="shop-header">
      <h2>Upgrades</h2>
      <div style="display:flex; align-items:center; gap:12px;">
        <span id="shopBalance" class="shop-balance">100</span>
        <button class="button button-secondary" onclick="window.Game && Game.closeShop()">Close</button>
      </div>
    </div>
    <div class="shop-tabs">
      <button class="tab active" onclick="window.Game && Game.switchTab('weapons', event)">Weapons</button>
      <button class="tab" onclick="window.Game && Game.switchTab('shields', event)">Shields</button>
      <button class="tab" onclick="window.Game && Game.switchTab('systems', event)">Systems</button>
    </div>
    <div id="shopItems" class="shop-items"></div>
  </div>

  <!-- Wave choice -->
  <div id="waveChoice" class="interstitial-screen">
    <h2>Choose Your Upgrade</h2>
    <p>Pick one to power up for the next wave.</p>
    <div id="choiceCards" class="choice-cards"></div>
  </div>

  <!-- Wave transition -->
  <div id="waveTransition" class="interstitial-screen">
    <h2>Wave Complete!</h2>
    <p>Prepare for the next assault.</p>
    <div style="display:flex; gap:8px; justify-content:center;">
      <button class="button" onclick="window.Game && Game.resumeGame()">Next Wave</button>
      <button class="button button-secondary" onclick="window.Game && Game.showInGameShop()">Visit Shop</button>
    </div>
  </div>

  <!-- Tutorial -->
  <div id="tutorial" class="interstitial-screen">
    <h2>How to Play</h2>
    <p>
      <strong>Objective:</strong> Defend Earth by destroying all incoming enemy ships before they reach the planet.<br><br>
      <strong>Controls:</strong> Your ship orbits Earth. Move the mouse (desktop) or swipe vertically (mobile) to rotate your ship. Firing is automatic.<br><br>
      <strong>Missiles:</strong> Tap the missile button to launch a powerful, homing missile.<br><br>
      <strong>Upgrades:</strong> After each wave, choose a temporary upgrade. Spend coins in the shop for permanent upgrades.
    </p>
    <div style="text-align:center;">
      <button class="button" onclick="window.Game && Game.closeTutorial()">Back to Menu</button>
    </div>
  </div>

  <!-- Pause -->
  <div id="pauseScreen" class="interstitial-screen" style="max-width:420px;">
    <h2>Paused</h2>
    <p style="text-align:center;">Press ESC to resume</p>
  </div>

  <!-- Death -->
  <div id="deathScreen" class="interstitial-screen">
    <h2>Mission Failed</h2>
    <div id="deathStats" class="death-stats"></div>
    <div id="deathRecommendation" class="death-recommendation"></div>
    <button class="button" onclick="window.Game && Game.closeDeathScreen()">Continue</button>
  </div>

  <!-- Victory -->
  <div id="victoryScreen" class="interstitial-screen">
    <h2>Victory!</h2>
    <!-- uses rectangular artwork; not forced square -->
    <img src="assets/IMG_1538.PNG" class="album-art" alt="Album Art">
    <div class="credits-text">
      <p><strong>Game Design</strong><br>D_York</p>
      <p><strong>Original Music by D_York</strong><br>Represented by United Masters</p>
      <p>Available on <a href="https://unitedmasters.com/m/oh-death-1" target="_blank" rel="noopener">Spotify &amp; Apple Music</a></p>
    </div>
    <button class="button" onclick="window.Game && Game.closeVictoryScreen()">Main Menu</button>
  </div>

  <script>
  'use strict';

  // -------------------- Audio Manager --------------------
  class AudioManager{
    constructor(){
      this.ctx = null;
      this.music = {};
      this.current = null;
      this.muted = false;
      this.musicVol = 0.45;
      this.sfxVol = 0.6;
      this.playlists = {
        menu: ['assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'],
        gameplay: [
          'assets/audio/m33_-_4_26_25__11_13_AM.m4a',
          'assets/audio/MIAMI__mret_-_5_27_24__5_09_PM_.m4a',
          'assets/audio/goodroots - 1_17_25, 9.41 PM.m4a',
          'assets/audio/newleed - 9_28_24, 6.48 PM.m4a',
          'assets/audio/hippiedancers_-_6_9_24__2_26_PM.m4a'
        ],
        boss: [
          'assets/audio/monster.mp3',
          'assets/audio/dumplin_-_7_6_24__8_51_PM.m4a'
        ],
        victory: ['assets/audio/propane2 - 12_21_24, 10.27 AM.m4a'],
        gameover: ['assets/audio/gameover.mp3']
      };
      this.queue = [];
      this.idx = 0;
      this.init();
    }

    async init(){
      try{
        this.ctx = (window.AudioContext||window.webkitAudioContext)? new (window.AudioContext||window.webkitAudioContext)() : null;
      }catch{ this.ctx = null; }
      // Preload tags (HTMLAudio); actual playback is gesture-gated
      for(const list of Object.values(this.playlists)){
        for(const src of list){
          if(!this.music[src]){
            const a = new Audio(src);
            a.preload='auto'; a.loop=false; a.volume=0;
            a.load();
            this.music[src]=a;
          }
        }
      }
      // wire mute button
      const btn=document.getElementById('muteBtn');
      if(btn){
        btn.addEventListener('click', ()=>this.toggleMute());
      }
    }

    kick(){ // resume + start menu if idle
      if(this.ctx && this.ctx.state==='suspended'){ this.ctx.resume().catch(()=>{}); }
      // if nothing is playing, start menu music
      if(!this.current || this.current.paused){
        this.playMusic('menu', 800);
      }
    }

    toggleMute(){
      this.muted=!this.muted;
      const btn=document.getElementById('muteBtn');
      if(btn){ btn.classList.toggle('muted', this.muted); }
      if(this.current){ this.current.volume = this.muted?0:this.musicVol; }
    }

    playMusic(name, fade=1200){
      const list=this.playlists[name]||[];
      if(!list.length) return;
      this.queue=[...list];
      if(name==='menu' || name==='gameplay'){ this.shuffle(this.queue); }
      this.idx=0;
      this.playTrack(this.queue[this.idx], fade, (name==='menu'||name==='gameplay'));
    }

    playTrack(src, fade, chain=false){
      const next=this.music[src]; if(!next) return;
      // stop others
      for(const a of Object.values(this.music)){ if(a && a!==next){ a.pause(); a.currentTime=0; a.volume=0; a.onended=null; } }
      // fade previous
      if(this.current){ this.fadeOut(this.current, fade); }
      this.current=next; next.currentTime=0;
      next.play().then(()=> this.fadeIn(next, fade, this.muted?0:this.musicVol)).catch(()=>{});
      if(chain){
        next.loop=false;
        next.onended=()=>{
          this.idx=(this.idx+1)%this.queue.length;
          this.playTrack(this.queue[this.idx], 800, true);
        };
      }else{
        next.loop=true; next.onended=null;
      }
    }

    fadeIn(a,dur,target){ if(!a) return; const steps=30, dt=dur/steps, inc=target/steps; a.volume=0;
      let i=0; const id=setInterval(()=>{ if(!a) return clearInterval(id);
        if(this.muted){ a.volume=0; return clearInterval(id); }
        i++; a.volume=Math.min(target, a.volume+inc); if(i>=steps) clearInterval(id);
      }, dt);
    }
    fadeOut(a,dur){ if(!a) return; const steps=30, dt=dur/steps, dec=(a.volume||0)/steps;
      let i=0; const id=setInterval(()=>{ if(!a) return clearInterval(id);
        i++; a.volume=Math.max(0, a.volume-dec); if(i>=steps){ a.pause(); a.volume=0; clearInterval(id); }
      }, dt);
    }
    duck(seconds=.3, amount=.5){
      if(!this.current || this.muted) return;
      const base=this.musicVol, target=base*amount;
      this.fadeTo(this.current, 120, target);
      setTimeout(()=> this.fadeTo(this.current, 240, base), seconds*1000);
    }
    fadeTo(a,dur,target){ if(!a) return; const steps=20, dt=dur/steps; const start=a.volume; const delta=(target-start)/steps;
      let i=0; const id=setInterval(()=>{ if(!a) return clearInterval(id);
        i++; a.volume = this.muted?0:(start + delta*i); if(i>=steps) clearInterval(id);
      }, dt);
    }
    shuffle(arr){ for(let i=arr.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [arr[i],arr[j]]=[arr[j],arr[i]]; } }

    // simple SFX with WebAudio
    sfx(type){
      if(!this.ctx || this.muted) return;
      const ctx=this.ctx, now=ctx.currentTime;
      const tone=(f, t=.1, g=.3, type='sine')=>{
        const o=ctx.createOscillator(), gain=ctx.createGain();
        o.type=type; o.frequency.setValueAtTime(f, now); o.connect(gain); gain.connect(ctx.destination);
        gain.gain.setValueAtTime(g*this.sfxVol, now); gain.gain.exponentialRampToValueAtTime(0.01, now+t);
        o.start(now); o.stop(now+t);
      };
      if(type==='shoot') tone(220, .08, .25, 'square');
      if(type==='hit') tone(140, .05, .35, 'sawtooth');
      if(type==='missile'){ tone(440, .25, .3, 'sawtooth'); this.duck(.3,.5); setTimeout(()=>this.sfx('explosion'), 300); }
      if(type==='explosion'){ for(let i=0;i<4;i++) setTimeout(()=>tone(80+Math.random()*60,.12,.35,'triangle'), i*40); }
      if(type==='upgrade'){ [440,554,659,880].forEach((f,i)=> setTimeout(()=>tone(f,.25,.24,'sine'), i*110)); }
      if(type==='warning'){ [440,554,440].forEach((f,i)=> setTimeout(()=>tone(f,.15,.3,'square'), i*180)); }
      if(type==='bossHit'){ tone(120,.2,.45,'square'); }
      if(type==='wave'){ [523,659,784,1047].forEach((f,i)=> setTimeout(()=>tone(f,.35,.3,'sine'), i*150)); }
    }
  }

  // -------------------- Game --------------------
  function initializeGame(){
    // Canvas + ctx
    const canvas=document.getElementById('gameCanvas');
    const ctx=canvas.getContext('2d');

    // Assets
    const bgImg=new Image(); bgImg.src='assets/background.png'; let bgInfo=null, bgLoaded=false;
    bgImg.onload=()=>{ bgLoaded=true; resize(); };

    const shipImg=new Image(); shipImg.src='assets/player-ship.jpg'; let shipLoaded=false; shipImg.onload=()=>shipLoaded=true;
    const shipDamImg=new Image(); shipDamImg.src='assets/player-ship-damaged.jpg'; let shipDamLoaded=false; shipDamImg.onload=()=>shipDamLoaded=true;

    const bossProjImg=new Image(); bossProjImg.src='assets/IMG_1439_2.JPG';

    // Audio
    const audio=new AudioManager();

    // Config
    const CFG={
      ORBIT_R:60,
      SHIELD_R:70,
      EARTH_COLLIDE_R:45,
      EARTH_IMPACT_R:35,
      ENEMY_HIT_R:25,
      BOSS_HIT_R:80,
      SHIP_SIZE:58,
      MAX_WAVES:20
    };

    // State
    let visualEarthX=0, visualEarthY=0; // derived from background fit
    let wave=1, score=0, lives=3, coins=100, missiles=3;
    let gameRunning=false, paused=false;
    let shipAngle=0, targetAngle=0;
    let lastT=performance.now();
    let enemies=[], projectiles=[], missilesArr=[], bossShots=[], particles=[];
    let showingWaveChoice=false, waitingNext=false, shopReturn='menu';
    let difficulty='normal';
    const deathStats={waveReached:1, enemiesKilled:0, coinsEarned:0, accuracy:'0%'};
    let shotsFired=0, shotsHit=0;

    // Shop data (kept consistent with your build)
    const shopItems={
      weapons:[
        {id:'basic', name:'Basic Cannon', cost:0, damage:1, fireRate:400, desc:'Standard issue.', sprite:'assets/IMG_1426_2.jpg'},
        {id:'spread', name:'Spread Shot', cost:250, damage:0.8, fireRate:450, desc:'5-way fan.', pattern:'spread', sprite:'assets/IMG_1405_2.jpg'},
        {id:'piercing', name:'Rail Gun', cost:500, damage:5, fireRate:1000, desc:'Pierces enemies.', beam:true, piercing:true, sprite:'assets/1408_2.jpg'},
        {id:'rapid', name:'Rapid Fire', cost:800, damage:0.5, fireRate:100, desc:'Stream of bullets.', rapid:true, sprite:'assets/IMG_1403_2.jpg'},
        {id:'burst', name:'Burst Cannon', cost:1200, damage:1.5, fireRate:600, desc:'3-shot bursts.', burst:3, sprite:'assets/IMG_1404_2.jpg'},
        {id:'plasma', name:'Plasma Wave', cost:2000, damage:3, fireRate:800, desc:'Expanding wave.', wave:true, sprite:'assets/IMG_1429_2.jpg'}
      ],
      shields:[
        {id:'basic', name:'Energy Shield', cost:300, health:100, desc:'Absorbs 100.', sprite:'assets/IMG_1424_2.jpg'},
        {id:'regen', name:'Regen Shield', cost:700, health:80, regen:2, desc:'+2 HP/s.', sprite:'assets/IMG_1423_2.jpg'}
      ],
      systems:[
        {id:'speed', name:'Thrusters', cost:300, speedBoost:1.5, desc:'+50% turn speed.', sprite:'assets/IMG_1422_2.jpg'},
        {id:'auto', name:'Auto-Targeter', cost:600, autoTarget:true, desc:'Aims at nearest.', sprite:'assets/IMG_1416_2.jpg'}
      ]
    };
    const gameState={
      equipment:{weapon:'basic', shield:null, system:null},
      owned:{weapons:['basic'], shields:[], systems:[]},
      maxShieldHealth:0, shieldHealth:0, temporaryUpgrades:[]
    };

    // ---------- helpers ----------
    function $(id){ return document.getElementById(id); }
    function updateUI(){
      const w=$('waveDisplay'), s=$('scoreDisplay'), l=$('livesDisplay'), c=$('coinsDisplay'), m=$('missilesDisplay'), b=$('shopBalance');
      if(w) w.textContent=wave;
      if(s) s.textContent=score;
      if(l) l.textContent=lives;
      if(c) c.textContent=coins;
      if(m) m.textContent=missiles;
      if(b) b.textContent=coins;
    }

    function resize(){
      canvas.width=innerWidth; canvas.height=innerHeight;
      // Fit background like CSS "cover"
      if(bgLoaded && bgImg.width){
        const cw=canvas.width, ch=canvas.height, ca=cw/ch;
        const ia=bgImg.width/bgImg.height;
        let dw, dh, ox, oy;
        if(ca>ia){ dw=cw; dh=dw/ia; ox=0; oy=(ch-dh)/2; }
        else{ dh=ch; dw=dh*ia; oy=0; ox=(cw-dw)/2; }
        bgInfo={x:ox,y:oy,w:dw,h:dh};
        // Earth visual center ~48% from top of background (as in your build)
        visualEarthX=ox + dw/2;
        visualEarthY=oy + dh*0.48;
      }else{
        visualEarthX=canvas.width/2; visualEarthY=canvas.height/2;
      }
    }
    window.addEventListener('resize', resize);
    resize();

    // ---------- input ----------
    let dragging=false, touchY=0;
    canvas.addEventListener('mousemove', e=>{
      if(!gameRunning || paused) return;
      const r=canvas.getBoundingClientRect();
      targetAngle=Math.atan2(e.clientY-r.top-visualEarthY, e.clientX-r.left-visualEarthX);
    });
    canvas.addEventListener('touchstart', e=>{ if(!gameRunning||paused) return; dragging=true; touchY=e.touches[0].clientY; }, {passive:true});
    canvas.addEventListener('touchmove', e=>{
      if(!gameRunning||paused||!dragging) return; const dy=e.touches[0].clientY-touchY; touchY=e.touches[0].clientY; targetAngle+=dy*0.008;
    }, {passive:true});
    canvas.addEventListener('touchend', ()=> dragging=false);
    document.addEventListener('keydown', e=>{
      if(e.key==='Escape'){ paused=!paused; $('pauseScreen').style.display=paused?'flex':'none';
        if(paused) audio.playMusic('menu',600); else audio.playMusic(isBossWave()?'boss':'gameplay',800);
      }
      if(!gameRunning||paused) return;
      if(e.key===' '){ e.preventDefault(); launchMissile(); }
      if(e.key==='a'||e.key==='ArrowLeft') targetAngle-=0.1;
      if(e.key==='d'||e.key==='ArrowRight') targetAngle+=0.1;
    });

    // ---------- draw ----------
    function drawBackground(){
      ctx.fillStyle='#0a0e1a'; ctx.fillRect(0,0,canvas.width,canvas.height);
      if(bgInfo) ctx.drawImage(bgImg, bgInfo.x, bgInfo.y, bgInfo.w, bgInfo.h);
    }
    function drawShield(){
      if(gameState.shieldHealth>0 && gameState.maxShieldHealth>0){
        const pct=gameState.shieldHealth/gameState.maxShieldHealth;
        ctx.save();
        ctx.strokeStyle=`rgba(34,211,238,${0.15+0.35*pct})`;
        ctx.lineWidth=2.5; ctx.setLineDash([6,6]);
        ctx.beginPath(); ctx.arc(visualEarthX, visualEarthY, CFG.SHIELD_R, 0, Math.PI*2); ctx.stroke();
        ctx.restore(); ctx.setLineDash([]);
      }
    }
    function drawShip(){
      const x=visualEarthX + Math.cos(shipAngle)*CFG.ORBIT_R;
      const y=visualEarthY + Math.sin(shipAngle)*CFG.ORBIT_R;
      ctx.save(); ctx.translate(x,y); ctx.rotate(shipAngle+Math.PI/2);
      const img=(lives<=2 && shipDamLoaded)? shipDamImg : (shipLoaded? shipImg : null);
      if(img){ ctx.globalCompositeOperation='lighter'; ctx.drawImage(img, -CFG.SHIP_SIZE/2, -CFG.SHIP_SIZE/2, CFG.SHIP_SIZE, CFG.SHIP_SIZE); ctx.globalCompositeOperation='source-over'; }
      else{ ctx.fillStyle:'#22d3ee'; ctx.beginPath(); ctx.arc(0,0, CFG.SHIP_SIZE/3, 0, Math.PI*2); ctx.fill(); }
      ctx.restore();
    }

    // ---------- enemies & projectiles (lightweight; preserves feel) ----------
    function spawnWave(){
      // music
      if(isBossWave()) audio.playMusic('boss', 800);
      else audio.playMusic('gameplay', 800);

      // simple spawn: wave*X basic enemies; boss every 5th
      enemies.length=0;
      if(isBossWave()){
        const angle=Math.random()*Math.PI*2;
        const dist=Math.max(canvas.width,canvas.height)*0.7;
        enemies.push({
          name:'boss', x:visualEarthX+Math.cos(angle)*dist, y:visualEarthY+Math.sin(angle)*dist,
          speed:.6, health:120+wave*18, maxHealth:120+wave*18, coins:200
        });
      }else{
        const count=6 + (wave-1)*2;
        for(let i=0;i<count;i++){
          const ang=Math.random()*Math.PI*2;
          const dist=Math.max(canvas.width,canvas.height)*0.75;
          enemies.push({
            name:'enemy',
            x:visualEarthX+Math.cos(ang)*dist, y:visualEarthY+Math.sin(ang)*dist,
            speed:.9 + Math.random()*.6, health:2+Math.random()*2 + wave*.25, maxHealth:3+wave*.25, coins:10+Math.floor(Math.random()*8)
          });
        }
      }
    }

    function isBossWave(){ return wave>0 && wave%5===0; }

    function autoFire(dt){
      const weaponId=gameState.equipment.weapon||'basic';
      const weapon=shopItems.weapons.find(w=>w.id===weaponId) || shopItems.weapons[0];
      autoFire.t = (autoFire.t||0) + dt*1000;
      const rate=weapon.fireRate||400;
      if(autoFire.t>=rate){ autoFire.t=0; fire(weapon); }
    }
    function fire(weapon){
      shotsFired++;
      audio.sfx('shoot');
      const speed=weapon.rapid?15:10;
      if(weapon.pattern==='spread'){
        for(let i=-2;i<=2;i++){
          const a=shipAngle + i*0.15;
          projectiles.push({x:visualEarthX+Math.cos(shipAngle)*CFG.ORBIT_R, y:visualEarthY+Math.sin(shipAngle)*CFG.ORBIT_R, vx:Math.cos(a)*speed, vy:Math.sin(a)*speed, d:weapon.damage||1, pierce:!!weapon.piercing, life:2});
        }
      }else{
        projectiles.push({x:visualEarthX+Math.cos(shipAngle)*CFG.ORBIT_R, y:visualEarthY+Math.sin(shipAngle)*CFG.ORBIT_R, vx:Math.cos(shipAngle)*speed, vy:Math.sin(shipAngle)*speed, d:weapon.damage||1, pierce:!!weapon.piercing, life:2});
      }
    }

    function launchMissile(){
      if(!gameRunning || missiles<=0) return;
      missiles--; updateUI(); audio.sfx('missile');
      // target nearest
      const sx=visualEarthX+Math.cos(shipAngle)*CFG.ORBIT_R;
      const sy=visualEarthY+Math.sin(shipAngle)*CFG.ORBIT_R;
      let target=null, best=1e9;
      enemies.forEach(e=>{ const d=(e.x-sx)**2+(e.y-sy)**2; if(d<best){best=d; target=e;} });
      missilesArr.push({x:sx,y:sy,vx:Math.cos(shipAngle)*6,vy:Math.sin(shipAngle)*6,target,life:5,damage:10});
    }

    function update(dt){
      // ship angle smoothing
      const diff=Math.atan2(Math.sin(targetAngle-shipAngle), Math.cos(targetAngle-shipAngle));
      shipAngle += diff * 0.15;

      // projectiles
      for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i]; p.x+=p.vx*dt*60; p.y+=p.vy*dt*60; p.life-=dt;
        if(p.life<=0 || outOfBounds(p.x,p.y)){ projectiles.splice(i,1); continue; }
      }

      // missiles
      for(let i=missilesArr.length-1;i>=0;i--){
        const m=missilesArr[i];
        if(m.target && enemies.includes(m.target)){
          const a=Math.atan2(m.target.y-m.y, m.target.x-m.x);
          m.vx=Math.cos(a)*8; m.vy=Math.sin(a)*8;
        }
        m.x+=m.vx*dt*60; m.y+=m.vy*dt*60; m.life-=dt;
        if(m.life<=0 || outOfBounds(m.x,m.y)){ missilesArr.splice(i,1); continue; }
      }

      // boss shots
      for(let i=bossShots.length-1;i>=0;i--){
        const b=bossShots[i]; b.x+=b.vx*dt*60; b.y+=b.vy*dt*60; b.rot=(b.rot||0)+dt*5;
        const de=Math.hypot(b.x-visualEarthX, b.y-visualEarthY);
        if(de<CFG.EARTH_COLLIDE_R){
          if(gameState.shieldHealth>0){ gameState.shieldHealth=Math.max(0, gameState.shieldHealth-10); audio.sfx('warning'); }
          else{ lives--; audio.sfx('warning'); if(lives<=0){ endGame(); return; } }
          bossShots.splice(i,1);
        }else if(outOfBounds(b.x,b.y)){ bossShots.splice(i,1); }
      }

      // enemies
      for(let i=enemies.length-1;i>=0;i--){
        const e=enemies[i];
        const a=Math.atan2(visualEarthY-e.y, visualEarthX-e.x);
        const v= (e.name==='boss'? e.speed : e.speed) * 60;
        e.x += Math.cos(a)*v*dt;
        e.y += Math.sin(a)*v*dt;

        // boss fires
        if(e.name==='boss'){
          e.t=(e.t||0)+dt*1000;
          if(e.t>2200){ e.t=0;
            const ang=a+(Math.random()-.5)*0.5;
            bossShots.push({x:e.x,y:e.y,vx:Math.cos(ang)*2,vy:Math.sin(ang)*2,rot:0});
            audio.sfx('shoot');
          }
        }

        // hit Earth
        const dE=Math.hypot(e.x-visualEarthX, e.y-visualEarthY);
        if(dE<CFG.EARTH_IMPACT_R){
          if(gameState.shieldHealth>0){
            const dmg=Math.min(gameState.shieldHealth, e.health);
            gameState.shieldHealth-=dmg;
          }else{
            lives--; if(lives<=0){ endGame(); return; }
          }
          enemies.splice(i,1);
          continue;
        }
      }

      // collisions: bullets vs enemies
      bulletLoop:
      for(let i=projectiles.length-1;i>=0;i--){
        const p=projectiles[i];
        for(let j=enemies.length-1;j>=0;j--){
          const e=enemies[j];
          const hr = (e.name==='boss'? CFG.BOSS_HIT_R : CFG.ENEMY_HIT_R);
          if(Math.hypot(p.x-e.x, p.y-e.y) < hr){
            shotsHit++; audio.sfx(e.name==='boss'?'bossHit':'hit');
            e.health -= p.d;
            if(e.health<=0){
              score += e.coins*2; coins += e.coins; deathStats.enemiesKilled++; audio.sfx(e.name==='boss'?'explosion':'explosion');
              enemies.splice(j,1);
            }
            if(!p.pierce){ projectiles.splice(i,1); }
            continue bulletLoop;
          }
        }
      }

      // missiles vs enemies
      missileLoop:
      for(let i=missilesArr.length-1;i>=0;i--){
        const m=missilesArr[i];
        for(let j=enemies.length-1;j>=0;j--){
          const e=enemies[j];
          const hr=(e.name==='boss'? CFG.BOSS_HIT_R: CFG.ENEMY_HIT_R);
          if(Math.hypot(m.x-e.x, m.y-e.y) < hr){
            e.health -= m.damage; audio.sfx('explosion');
            if(e.health<=0){ score += e.coins*2; coins += e.coins; deathStats.enemiesKilled++; enemies.splice(j,1); }
            missilesArr.splice(i,1);
            continue missileLoop;
          }
        }
      }

      // wave clear â†’ choice/next
      if(gameRunning && enemies.length===0 && !showingWaveChoice && !waitingNext){
        waitingNext=true;
        if(wave>=CFG.MAX_WAVES){ showVictoryScreen(); return; }
        wave++; deathStats.waveReached=wave; coins+=wave*50; missiles=Math.min(10, missiles+1);
        audio.sfx('wave'); updateUI(); save(); showWaveChoice();
      }
    }

    function draw(){
      drawBackground(); drawShield(); drawShip();

      // projectiles
      ctx.fillStyle='#22d3ee';
      projectiles.forEach(p=>{ ctx.beginPath(); ctx.arc(p.x,p.y,3,0,Math.PI*2); ctx.fill(); });

      // missiles
      ctx.fillStyle='#ef4444';
      missilesArr.forEach(m=>{ ctx.beginPath(); ctx.arc(m.x,m.y,5,0,Math.PI*2); ctx.fill(); });

      // boss shots (with image)
      bossShots.forEach(b=>{
        ctx.save(); ctx.translate(b.x,b.y); ctx.rotate(b.rot||0);
        if(bossProjImg.complete && bossProjImg.naturalWidth){ ctx.drawImage(bossProjImg, -15, -15, 30, 30); }
        else{ ctx.fillStyle='#f00'; ctx.fillRect(-10,-10,20,20); }
        ctx.restore();
      });

      // enemies
      enemies.forEach(e=>{
        ctx.save(); ctx.translate(e.x,e.y);
        const sz=(e.name==='boss')?160:50;
        ctx.fillStyle= (e.name==='boss') ? '#ff4d4d' : '#f59e0b';
        ctx.beginPath(); ctx.arc(0,0, sz/2, 0, Math.PI*2); ctx.fill();
        // health bar
        const pct=Math.max(0, Math.min(1, e.health/e.maxHealth));
        const w=sz*0.8, h=6;
        ctx.fillStyle='rgba(0,0,0,.5)'; ctx.fillRect(-w/2, -sz/2-14, w, h);
        ctx.fillStyle= pct>0.3? '#10b981' : '#ef4444'; ctx.fillRect(-w/2, -sz/2-14, w*pct, h);
        ctx.restore();
      });
    }

    // ---------- screens / UI ----------
    function showShop(){
      if($('menu').style.display!=='none'||$('deathScreen').style.display!=='none') shopReturn='menu';
      $('menu').style.display='none';
      $('deathScreen').style.display='none';
      $('shop').style.display='flex';
      renderShop('weapons');
    }
    function closeShop(){
      $('shop').style.display='none';
      if(shopReturn==='in_game'){ $('waveTransition').style.display='flex'; } else { $('menu').style.display='block'; }
    }
    function showInGameShop(){ shopReturn='in_game'; $('waveTransition').style.display='none'; showShop(); }
    function showTutorial(){ $('menu').style.display='none'; $('tutorial').style.display='flex'; }
    function closeTutorial(){ $('tutorial').style.display='none'; $('menu').style.display='block'; }

    function switchTab(tabName, ev){
      document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
      if(ev && ev.currentTarget) ev.currentTarget.classList.add('active');
      renderShop(tabName);
    }
    function renderShop(cat){
      const box=$('shopItems'); if(!box) return; box.innerHTML='';
      const key= cat==='weapons'?'weapon' : (cat==='shields'?'shield':'system');
      (shopItems[cat]||[]).forEach(item=>{
        const owned=(gameState.owned[cat]||[]).includes(item.id);
        const equipped=gameState.equipment[key]===item.id;
        const can=coins>=item.cost;
        const card=document.createElement('div'); card.className='item-card'+(equipped?' equipped':'');
        card.innerHTML=`
          <img src="${item.sprite}" class="item-sprite" alt="${item.name}" onerror="this.style.display='none'">
          <div class="item-name" style="color:var(--accent); font-weight:700">${item.name}</div>
          <div class="item-desc" style="font-size:.8rem; color:var(--text-2)">${item.desc||''}</div>
          <div class="item-price" style="font-family:var(--font-mono); color:var(--warn)">${item.cost>0?('ðŸ’° '+item.cost):'Free'}</div>
          ${equipped?'<div class="item-equipped-badge" style="color:var(--good); font-size:.8rem; font-weight:700">Equipped</div>':''}
        `;
        if(!owned && item.cost>0){
          const btn=document.createElement('button'); btn.className='button'; btn.textContent= can?'Buy':'Not enough coins';
          btn.disabled=!can; btn.onclick=()=>buyItem(cat,item.id); card.appendChild(btn);
        }else if(!equipped){
          const btn=document.createElement('button'); btn.className='button'; btn.textContent='Equip';
          btn.onclick=()=>equipItem(cat,item.id); card.appendChild(btn);
        }
        box.appendChild(card);
      });
    }
    function buyItem(cat,id){
      const item=(shopItems[cat]||[]).find(i=>i.id===id); if(!item||coins<item.cost) return;
      coins-=item.cost; (gameState.owned[cat]||(gameState.owned[cat]=[])).push(id); audio.sfx('upgrade'); updateUI(); save(); renderShop(cat);
    }
    function equipItem(cat,id){
      const key=cat==='weapons'?'weapon':(cat==='shields'?'shield':'system');
      gameState.equipment[key]=id;
      if(cat==='shields'){
        const sh=shopItems.shields.find(s=>s.id===id);
        gameState.maxShieldHealth=sh?.health||0; gameState.shieldHealth=sh?.health||0;
      }
      save(); renderShop(cat);
    }

    function showWaveChoice(){
      gameRunning=false; showingWaveChoice=true;
      $('waveChoice').style.display='flex';
      const list=$('choiceCards'); list.innerHTML='';
      const choices=[
        {name:'Fire Rate Boost', type:'fireRate', value:.8, effect:'+20% fire rate'},
        {name:'Damage Boost', type:'damage', value:1.5, effect:'+50% damage'},
        {name:'Missiles+', type:'missiles', value:3, effect:'+3 missiles'}
      ];
      choices.forEach(ch=>{
        const card=document.createElement('div'); card.className='item-card';
        card.innerHTML=`<div class="choice-card-name" style="color:var(--accent); font-weight:700">${ch.name}</div>
                        <div class="choice-card-desc" style="color:var(--text-2)">Temporary bonus for the next wave.</div>
                        <div class="choice-card-effect" style="color:var(--good); font-weight:700">${ch.effect}</div>`;
        card.onclick=()=>selectWaveChoice(ch);
        list.appendChild(card);
      });
    }
    function selectWaveChoice(ch){
      audio.sfx('upgrade');
      if(ch.type==='missiles'){ missiles+=ch.value; }
      else gameState.temporaryUpgrades.push(ch);
      $('waveChoice').style.display='none'; showingWaveChoice=false; $('waveTransition').style.display='flex';
    }
    function resumeGame(){
      $('waveTransition').style.display='none'; gameRunning=true; waitingNext=false; spawnWave();
    }

    // ---------- persistence ----------
    function save(){
      try{
        localStorage.setItem('earthDefenderSave', JSON.stringify({coins, gameState}));
      }catch{}
    }
    function load(){
      try{
        const d=JSON.parse(localStorage.getItem('earthDefenderSave')||'null');
        if(d){ coins=d.coins??coins; if(d.gameState) Object.assign(gameState, d.gameState); }
      }catch{}
    }

    // ---------- flow ----------
    function startGame(level='normal'){
      difficulty=level;
      // menu -> HUD
      $('menu').style.display='none';
      const t=$('titleImage'); if(t) t.style.display='none';
      $('hud').style.display='flex';
      $('missileButton').style.display='flex';

      // reset
      gameRunning=true; paused=false;
      wave=1; score=0; lives=3; missiles=3;
      enemies.length=0; projectiles.length=0; missilesArr.length=0; bossShots.length=0;
      shotsFired=0; shotsHit=0; deathStats.waveReached=1; deathStats.enemiesKilled=0; deathStats.coinsEarned=coins;

      updateUI(); spawnWave();
      audio.playMusic('gameplay', 800);
    }

    function endGame(){
      audio.playMusic('gameover', 600);
      gameRunning=false; $('hud').style.display='none'; $('missileButton').style.display='none';
      showDeath();
    }
    function showDeath(){
      const stats=$('deathStats'), rec=$('deathRecommendation');
      if(stats){
        stats.innerHTML = `
          <div class="death-stat-row"><span>Waves Survived</span><span>${deathStats.waveReached-1}</span></div>
          <div class="death-stat-row"><span>Enemies Killed</span><span>${deathStats.enemiesKilled}</span></div>
          <div class="death-stat-row"><span>Final Score</span><span>${score}</span></div>
          <div class="death-stat-row"><span>Coins Earned</span><span>${coins - deathStats.coinsEarned}</span></div>
          <div class="death-stat-row"><span>Accuracy</span><span>${shotsFired?((shotsHit/shotsFired*100).toFixed(1)+'%'):'0%'}</span></div>
        `;
      }
      if(rec) rec.textContent = (deathStats.waveReached<5) ? 'Try upgrading your weapon or shield.' :
                               (deathStats.waveReached<10)? 'Spread Shot or Rail Gun help mid-game.' :
                               'Great run!';
      $('deathScreen').style.display='flex'; save();
    }
    function closeDeathScreen(){
      audio.playMusic('menu', 600);
      $('deathScreen').style.display='none';
      $('menu').style.display='block';
      const t=$('titleImage'); if(t) t.style.display='block';
    }
    function showVictoryScreen(){
      audio.playMusic('victory', 600);
      gameRunning=false; $('hud').style.display='none'; $('missileButton').style.display='none';
      $('victoryScreen').style.display='flex'; save();
    }
    function closeVictoryScreen(){
      audio.playMusic('menu', 600);
      $('victoryScreen').style.display='none';
      $('menu').style.display='block';
      const t=$('titleImage'); if(t) t.style.display='block';
    }

    function outOfBounds(x,y){ return x<-150 || x>canvas.width+150 || y<-150 || y>canvas.height+150; }

    // ---------- loop ----------
    function loop(now){
      requestAnimationFrame(loop);
      if(paused){ drawBackground(); drawShield(); drawShip(); return; }
      const dt=Math.min((now-lastT)/1000, 0.017); lastT=now;
      if(gameRunning){ update(dt); autoFire(dt); }
      draw();
    }

    // init
    load();
    updateUI();
    audio.playMusic('menu', 800); // will be silent until first gesture in many browsers; we also kick below
    requestAnimationFrame(loop);

    // gesture to unlock audio & ensure menu music
    const firstGesture=()=>{ audio.kick(); window.removeEventListener('pointerdown', firstGesture); window.removeEventListener('keydown', firstGesture); };
    window.addEventListener('pointerdown', firstGesture, {once:true});
    window.addEventListener('keydown', firstGesture, {once:true});

    // public API
    return {
      // audio
      kickAudio: ()=>audio.kick(),

      // game
      startGame, resumeGame, launchMissile,
      // screens
      showShop, closeShop, showInGameShop,
      showTutorial, closeTutorial,
      closeDeathScreen, closeVictoryScreen,
      // shop
      switchTab,
      // settings
      setDifficulty:(d)=>{difficulty=d;}
    };
  }

  // -------------------- Boot --------------------
  window.addEventListener('DOMContentLoaded', ()=>{
    try{
      window.Game = initializeGame();
    }catch(e){
      console.error('Init error:', e);
    }

    // wire extra common selectors safely (if present)
    const tryStart=()=>{ window.Game?.startGame?.('normal'); window.Game?.kickAudio?.(); };
    ['#startBtn','#playButton','#menuStart','#beginBtn','#start','#play','.start','.play']
      .forEach(sel=> document.querySelectorAll(sel).forEach(b=> b.addEventListener('click', tryStart)));

    // always allow a gesture to kick audio
    const kick=()=> window.Game?.kickAudio?.();
    window.addEventListener('pointerdown', kick, {once:true});
    window.addEventListener('keydown', kick, {once:true});
  });
  </script>
</body>
</html>
